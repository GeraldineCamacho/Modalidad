---
title: "Pruebas varias"
author: "Yilber Alejandro Erazo Bolaños"
date: "10/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Prueba de unión indicador supersalud

```{r}

#leer datos
supersalud <- read_excel("supersalud_indicadores.xlsx")

supersalud <- as.data.table(supersalud)

# Para que coincidan los nombres corregir los nombres de supersalud
supersalud[NIT == "812004010", Entidad := "ESE CAMU DE BUENAVISTA"]
supersalud[NIT == "891200248", Entidad := "ESE HOSPITAL CLARITA SANTOS"]
supersalud[NIT == "800193904", Entidad := "ESE HOSPITAL JUAN PABLO II DE ARATOCA"] # tiene 2 NIT
supersalud[NIT == "890981268", Entidad := "ESE HOSPITAL LA ANUNCIACION DE MUTATA"]
supersalud[NIT == "900066347", Entidad := "ESE HOSPITAL REGIONAL DE SAN GIL"]
supersalud[NIT == "800123106", Entidad := "ESE HOSPITAL VENANCIO DIAZ DIAZ DE SABANETA"]
supersalud[NIT == "834001482", Entidad := "ESE JAIME ALVARADO Y CASTILLA"]
supersalud[NIT == "820002468", Entidad := "ESE PUESTO DE SALUD DE CIENEGA"]
supersalud[NIT == "900147959", Entidad := "ESE CENTRO DE SALUD TIMOTEO RIVEROS CUBILLOS DE UNE"]
supersalud[NIT == "891501104", Entidad := "ESE HOSPITAL DE EL TAMBO"] # tiene 2 NIT
supersalud[NIT == "890981137", Entidad := "ESE HOSPITAL FRANCISCO VALDERRAMA DE TURBO"]
supersalud[NIT == "890982139", Entidad := "ESE HOSPITAL SAN LORENZO DE LIBORINA"]
supersalud[NIT == "804005695", Entidad := "ESE SAN ISIDRO"] #tiene 2 NIT pero 8004MAL
supersalud[NIT == "890802036", Entidad := "HOSPITAL DE SAN MARCOS DE CHINCHINA"]
supersalud[NIT == "809001086", Entidad := "HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS"]
supersalud[NIT == "800130625", Entidad := "HOSPITAL SAN CRISTOBAL DE CIENAGA"]
supersalud[NIT == "890680031", Entidad := "HOSPITAL SAN ANTONIO DE ARBELAEZ"]
supersalud[NIT == "810000913", Entidad := "HOSPITAL SAN FELIX DE LA DORADA"]
supersalud[NIT == "800204497", Entidad := "HOSPITAL SAN JOSE DE GUACHETA"]
supersalud[NIT == "890907254", Entidad := "HOSPITAL SAN JUAN DE DIOS DE RIONEGRO"]
supersalud[NIT == "809001086", Entidad := "HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS"]
supersalud[NIT == "891900356", Entidad := "HOSPITAL SANTANDER DE CAICEDONIA"]
supersalud[NIT == "804015007", Entidad := "IPS CENTRO DE SALUD DE ENCINO"]

#supersalud_unicos <- supersalud %>% unique(Entidad)

data.table(supersalud %>% count(Entidad) %>% arrange(desc(n)))


data.table(supersalud %>% group_by(Entidad)) %>% arrange(Entidad)
#supersalud <- supersalud %>% 
  filter(Entidad %in% supersalud_unicos$Entidad)
  
supersalud %>% count(NIT, Entidad) %>% arrange(desc(n))

supersalud %>% group_by(Entidad) %>% summarise(dis = n_distinct(NIT)) %>% arrange(desc(dis))
```

```{r}

indicadores_prueba <- read.csv("indicadores_BD.csv")

indicadores_prueba <- indicadores_prueba %>% 
  mutate_if(is.character, factor) %>% 
  rename("inmdm_ind_puntaje_res_2018_mun" = "ind_ppuntaje_res_2018_mun",
         "indba_ind_riesgo_corrupcion" = "ind_riesgo_corrupcion")

indicadores_prueba$X <- NULL
indicadores_prueba$cod_entidad <- NULL #porque hay muy pccos datos de cada municipio
#indicadores_prueba$nit_entidad <- NULL
indicadores_prueba$cod_departamento <- NULL #porque ya se tiene el ombre del departamento
indicadores_prueba$municipio_entidad <- NULL #porque hay muy pocos datos de cada municipio
indicadores_prueba$depto_mun <- NULL #porque hay muy pocos datos de cada municipio

#Eliminar contratación directa
indicadores_prueba$indba_perc_direc_val <- NULL #porque se supone que no tenemos info de contr. 
indicadores_prueba$indba_perc_cerrada_num <- NULL
indicadores_prueba$indba_perc_cerrada_val <- NULL

#para volver a correr el modelo porque con esta columna genera error 
#indicadores_clas$nombre_entidad <- NULL


indicadores_prueba <- indicadores_prueba %>% 
  mutate(riesgo = case_when(indba_perc_cdirec_num <= 25 ~ "Bajo o Moderado",
                            indba_perc_cdirec_num <= 55 ~ "Medio",
                            TRUE ~ "Alto"))

indicadores_prueba <- indicadores_prueba[ , c(1:21, 186)]

head(indicadores_prueba)
```

```{r}
supersalud %>% group_by(NIT)
supersalud %>% distinct(Entidad)
indicadores_prueba %>% distinct(nit_entidad)
indicadores_prueba %>% distinct(nombre_entidad)

#ver cuántos coinciden por nombre exacto
supersalud %>% 
  filter(Entidad %in% prueba_union$nombre_entidad)
```


Cambios en supersalud
```{r}
# reemplazar EMPRESA SOCIAL DEL ESTADO por ESE
#supersalud[Entidad]

#eliminar tildes
supersalud$Entidad <- chartr('ÁÉÍÓÚ', 'AEIOU', supersalud$Entidad)

#eliminar puntos
supersalud$Entidad  <- gsub("[.]", "", supersalud$Entidad )

supersalud$NIT <- as.character(supersalud$NIT)

```



```{r}
#hacer el join o merge
indicadores_prueba <- indicadores_prueba %>% 
  separate(nombre_entidad, sep = " - ", into = c("Depto", "Hospital"), remove = FALSE) %>% 
  dplyr::select(-Depto) %>% 
  separate(nit_entidad, sep = "-", into = "nit_entidad")
  
#eliminar tildes
indicadores_prueba$Hospital <- chartr('ÁÉÍÓÚ', 'AEIOU', indicadores_prueba$Hospital)

#eliminar puntos
indicadores_prueba$Hospital <- gsub("[.]", "", indicadores_prueba$Hospital)

indicadores_prueba$nit_entidad <- gsub("[.]", "", indicadores_prueba$nit_entidad)
  
#ver cuántos coinciden 
supersalud %>% filter(Entidad %in% indicadores_prueba$Hospital)

#no_coinciden_super <- supersalud %>% filter(!(NIT %in% prueba_union$nit_entidad) & 
#                                            !(Entidad %in% prueba_union$Hospital))

#no_coinciden_puni <- prueba_union %>% filter(!(nit_entidad %in% supersalud$NIT) &
#                                            !(Hospital %in% supersalud$Entidad))

# Los que sí coinciden por nit o por nombre (862)
indicadores_prueba %>% filter((nit_entidad %in% supersalud$NIT) |
                                            (Hospital %in% supersalud$Entidad))

# Los que sí coinciden por nit (797)
indicadores_prueba %>% filter((nit_entidad %in% supersalud$NIT))

# Los que sí coinciden por nombre pero no por NIT (01)
indicadores_prueba %>% filter((Hospital %in% supersalud$Entidad) &
                                !(nit_entidad %in% supersalud$NIT))

indicadores_prueba_2 <- merge(x = indicadores_prueba,
                              y = supersalud,
                              by.x = "nit_entidad",
                              by.y = "NIT",
                              all.x = TRUE,
                              all.y = FALSE) %>%
  select(-Hospital, -Entidad)
  

no_coinciden_puni %>% filter(Hospital %in% no_coinciden_super$Hospital)

prueba_union %>% filter(nit_entidad %in% supersalud$NIT)

prueba_union %>% 
  filter((nit_entidad %in% supersalud$NIT))

indicadores_prueba %>% filter(nit_entidad > 0)

indicadores_prueba_2 <- indicadores_prueba

indicadores_prueba_2$nit_entidad <- as.numeric(indicadores_prueba_2$nit_entidad)

```

para cambiar el secop (segundos)
```{r}

#supersalud[NIT == "812004010", Entidad := "ESE CAMU DE BUENAVISTA"]

indicadores_prueba <- as.data.table(indicadores_prueba)

indicadores_prueba[Hospital == "ESE CAMU DE BUENAVISTA", nit_entidad := "812004010"]
indicadores_prueba[Hospital == "ESE CAMU DEL PRADO", nit_entidad := "812002836"]
indicadores_prueba[Hospital == "ESE CENTRO DE SALUD SAN VICENTE FERRER", nit_entidad := "820003431"]
indicadores_prueba[Hospital == "ESE CENTRO DE SALUD TIMOTEO RIVEROS CUBILLOS DE UNE", nit_entidad := "900147959"]
indicadores_prueba[Hospital == "ESE HOSPITAL CLARITA SANTOS", nit_entidad := "891200248"]
indicadores_prueba[Hospital == "ESE HOSPITAL DE EL TAMBO", nit_entidad := "891501104"]
indicadores_prueba[Hospital == "ESE HOSPITAL FRANCISCO VALDERRAMA DE TURBO", nit_entidad := "890981137"]
indicadores_prueba[Hospital == "ESE HOSPITAL JUAN PABLO II DE ARATOCA", nit_entidad := "800193904"]
indicadores_prueba[Hospital == "ESE HOSPITAL LA ANUNCIACION DE MUTATA", nit_entidad := "890981268"]
indicadores_prueba[Hospital == "ESE HOSPITAL NUESTRA SEÑORA DE LA CANDELARIA", nit_entidad := "890981719"]
indicadores_prueba[Hospital == "ESE HOSPITAL NUESTRA SEÑORA SANTA ANA", nit_entidad := "819000626"]
indicadores_prueba[Hospital == "ESE HOSPITAL REGIONAL DE SAN GIL", nit_entidad := "900066347"]
indicadores_prueba[Hospital == "ESE HOSPITAL REGIONAL NORTE", nit_entidad := "807008857"]
indicadores_prueba[Hospital == "ESE HOSPITAL SAN JOSE", nit_entidad := "891901745"]
indicadores_prueba[Hospital == "ESE HOSPITAL SAN LORENZO DE LIBORINA", nit_entidad := "890982139"]
#indicadores_prueba[Hospital == "ESE HOSPITAL SAN VICENTE DE PAUL", nit_entidad := ""] # ojo con este
indicadores_prueba[Hospital == "ESE HOSPITAL VENANCIO DIAZ DIAZ DE SABANETA", nit_entidad := "800123106"]
indicadores_prueba[Hospital == "ESE JAIME ALVARADO Y CASTILLA", nit_entidad := "834001482"]
indicadores_prueba[Hospital == "ESE PUESTO DE SALUD DE CIENEGA", nit_entidad := "820002468"]
indicadores_prueba[Hospital == "ESE SAN ISIDRO", nit_entidad := "804005695"]
indicadores_prueba[Hospital == "HOSPITAL DE SAN MARCOS DE CHINCHINA", nit_entidad := "890802036"]
indicadores_prueba[Hospital == "HOSPITAL SAN ANTONIO DE ARBELAEZ", nit_entidad := "890680031"]
indicadores_prueba[Hospital == "HOSPITAL SAN CRISTOBAL DE CIENAGA", nit_entidad := "800130625"]
indicadores_prueba[Hospital == "HOSPITAL SAN FELIX DE LA DORADA", nit_entidad := "810000913"]
indicadores_prueba[Hospital == "HOSPITAL SAN JOSE DE GUACHETA", nit_entidad := "800204497"]
indicadores_prueba[Hospital == "HOSPITAL SAN JUAN DE DIOS DE RIONEGRO", nit_entidad := "890907254"]
indicadores_prueba[Hospital == "HOSPITAL SANTANDER DE CAICEDONIA", nit_entidad := "891900356"]
indicadores_prueba[Hospital == "HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS", nit_entidad := "809001086"]
indicadores_prueba[Hospital == "IPS CENTRO DE SALUD DE ENCINO", nit_entidad := "804015007"]

```




Para cambiar en supersalud (primeros)
```{r}

DT[UID == "17-12-6670053-6063825", valor_inicial:=1568000]

Supersalud --- indicadres
812004010 ESE CAMU BUENAVISTA --- No registra , ESE CAMU DE BUENAVISTA
891200248 ESE HOSPITAL CLARITA SANTOS DE SANDONA --- No registra, ESE HOSPITAL CLARITA SANTOS
800193904 ESE HOSPITAL JUAN PABLO II ARATOCA --- 832193904, ESE HOSPITAL JUAN PABLO II DE ARATOCA
890981268 ESE HOSPITAL LA ANUNCIACION --- No registra, ESE HOSPITAL LA ANUNCIACION DE MUTATA
900066347 ESE HOSPITAL REGIONAL SAN GIL --- No registra, ESE HOSPITAL REGIONAL DE SAN GIL
800123106 ESE HOSPITAL VENANCIO DIAZ DIAZ --- No registra,ESE HOSPITAL VENANCIO DIAZ DIAZ DE SABANETA
834001482 EMPRESA SOCIAL DEL ESTADO JAIME ALVARADO Y CASTILLA --- ESE JAIME ALVARADO Y CASTILLA
820002468 EMPRESA SOCIAL DEL ESTADO PUESTO DE SALUD DE CIENEGA --- No registra, ESE PUESTO DE SALUD DE CIENEGA
900147959 EMPRESA SOCIAL DEL ESTADO CENTRO DE SALUD TIMOTEO RIVEROS CUBILLOS --- No registra, ESE CENTRO DE SALUD TIMOTEO RIVEROS CUBILLOS DE UNE
891501104 EMPRESA SOCIAL DEL ESTADO HOSPITAL DE EL TAMBO CAUCA --- 981501104, ESE HOSPITAL DE EL TAMBO
890981137 EMPRESA SOCIAL DEL ESTADO HOSPITAL FRANCISCO VALDERRAMA --- No registra, ESE HOSPITAL FRANCISCO VALDERRAMA DE TURBO
890982139 EMPRESA SOCIAL DEL ESTADO HOSPITAL SAN LORENZO --- No registra, ESE HOSPITAL SAN LORENZO DE LIBORINA
817003532 QUILISALUD ESE --- 817.003.532, ESE QUILISALUD
804005695 ESE SAN ISIDRO DEL MUNICIPIO DE TONA --- 800400695, ESE SAN ISIDRO 8004MAL
890802036 ESE HOSPITAL SAN MARCOS --- No registra, HOSPITAL DE SAN MARCOS DE CHINCHINA
809001086 HOSPITAL SERAFIN MONTAÑA CUELLAR ESE --- No registra, HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS
800130625 ESE HOSPITAL SAN CRISTOBAL DE CIENAGA --- No registra, HOSPITAL SAN CRISTOBAL DE CIENAGA
890680031 ESE HOSPITAL SAN ANTONIO DE ARBELAEZ --- No registra, HOSPITAL SAN ANTONIO DE ARBELAEZ
810000913 ESE HOSPITAL SAN FELIX - LA DORADA --- No registra, HOSPITAL SAN FELIX DE LA DORADA
800204497 ESE HOSPITAL SAN JOSE DE GUACHETA --- No registra, HOSPITAL SAN JOSE DE GUACHETA
890907254 HOSPITAL SAN JUAN DE DIOS ESE RIONEGRO - ANTIOQUIA --- No registra, HOSPITAL SAN JUAN DE DIOS DE RIONEGRO
809001086 HOSPITAL SERAFIN MONTAÑA CUELLAR ESE --- No registra, HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS
891900356 ESE HOSPITAL SANTANDER --- No registra, HOSPITAL SANTANDER DE CAICEDONIA
804015007 ESE CENTRO DE SALUD ENCINO --- No registra, IPS CENTRO DE SALUD DE ENCINO
```


Otros indicdores supersalud (Primer semestre de 2015)

```{r}
supersalud_calidad_20151 <- read_excel("Indicadores_Supersalud_Calidad_IPS_I _SEM _2015.xlsx",
                                       sheet = "Base_Publicas")

supersalud_calidad_20151 <- as.data.table(supersalud_calidad_20151)


supersalud_calidad_20151$...17 <- NULL

names(supersalud_calidad_20151) <- c(
  "cod_depto",
  "depto",
  "cod_municipio",
  "municipio",
  "prestadora",
  "nit_ips",
  "codigo_habil",
  "cod_indicador",
  "indicador",
  "medida",
  "numerador",
  "denominador",
  "valor",
  "validacion",
  "anio",
  "periodo"
)

head(supersalud_calidad_20151)
```


```{r}
#cuántas de las entidades que hay en supersalud 2015 también están en indicadores_BD

# por nit
supersalud_calidad_20151 %>%
  filter(nit_ips %in% indicadores_BD$nit_entidad) %>% count(nit_ips)

# por nombre
supersalud_calidad_20151 %>%
  filter(prestadora %in% indicadores_BD$nombre_entidad) %>% count(prestadora)

# LOS QUE NO COINCIDEN por nit
no_nit_supers2015 <- supersalud_calidad_20151 %>%
  filter(!(nit_ips %in% indicadores_BD$nit_entidad)) %>% 
  group_by(prestadora) %>% 
  select(depto, municipio, prestadora, nit_ips) %>% 
  unique() %>% 
  arrange(prestadora)

no_nit_indicadores_bd <- indicadores_BD %>% 
  filter(!(nit_entidad %in% supersalud_calidad_20151$nit_ips)) %>% 
  select(nombre_entidad, depto_mun, nit_entidad) %>% 
  arrange(nombre_entidad)

indicadores_BD %>% count(nit_entidad)
```

Lipieza de supersalud_2015

```{r}

# la columna valor está como tipo character debido a que hay 639 NR y 29 NA
# reemplazar los NA
supersalud_calidad_20151$valor[is.na(supersalud_calidad_20151$valor)] <- "0"

# reemplazar los NR
supersalud_calidad_20151$valor[supersalud_calidad_20151$valor == "NR"] <- "0"

#pasar a numeric la columna valor para poder agrupar por nits después
supersalud_calidad_20151$valor <- as.numeric(supersalud_calidad_20151$valor)

#eliminar tildes de los indicadores
supersalud_calidad_20151$indicador <- chartr('áéíóú', 'aeiou', supersalud_calidad_20151$indicador)

#poner los nombres de los indicadores bien
supersalud_calidad_20151$indicador <- gsub(" ", "_", supersalud_calidad_20151$indicador)

head(supersalud_calidad_20151)

# agrupar y hacer pivot_wider para poder contar los NAs por cada indicador
supersalud_calidad_20151 <- supersalud_calidad_20151 %>%
  group_by(nit_ips,
           prestadora,
           indicador) %>%
  summarise(valor_medio = mean(valor)) %>%
  pivot_wider(names_from = indicador,
              values_from = valor_medio) 
#%>% 
supersalud_calidad_20151 <- supersalud_calidad_20151 %>% dplyr::select(nit_ips,
                prestadora,
                Tasa_de_satisfacion_global,
                Oportunidad_de_la_asignacion_de_citas_en_la_consulta_medica_general,
                Oportunidad_en_la_atencion_en_consulta_de_odontologia_general,
                Proporcion_de_pacientes_con_hipertension_arterial_controlada) %>% 
  rename(
    "supers_tasa_satis_global_hos" = "Tasa_de_satisfacion_global",
    "supers_oportun_asign_citas_consulta_general_hos" = "Oportunidad_de_la_asignacion_de_citas_en_la_consulta_medica_general",
    "supers_oportun_atencion_consulta_odonto_general_hos" = "Oportunidad_en_la_atencion_en_consulta_de_odontologia_general",
    "supers_perc_pacientes_hipertension_hos" = "Proporcion_de_pacientes_con_hipertension_arterial_controlada"
  )

# ver los NA por cada columna
sapply(supersalud_calidad_20151, function(x) sum(is.na(x)))

```


Reemplazar en indicadores_bd

```{r}
indicadores_BD[nombre_entidad =="ANTIOQUIA - HOSPITAL MANUEL URIBE ÁNGEL DE ENVIGADO", nit_entidad := "890906347"]
indicadores_BD[nombre_entidad =="ANTIOQUIA - E.S.E. HOSPITAL SAN JUAN DE DIOS DE EL PEÑOL", nit_entidad := "890980486"]
indicadores_BD[nombre_entidad =="ANTIOQUIA - HOSPITAL SAN RAFAEL DE ANDES", nit_entidad := "890980814"]
indicadores_BD[nombre_entidad == "ANTIOQUIA - E.S.E. HOSPITAL GILBERTO MEJÍA MEJÍA DE RIONEGRO", nit_entidad := "800176899"]
indicadores_BD[nombre_entidad =="ANTIOQUIA - EMPRESA SOCIAL DEL ESTADO HOSPITAL PRESBÍTERO ALONSO MARÍA GIRALDO - SAN RAFAEL", nit_entidad := "891982128"]
indicadores_BD[nombre_entidad =="ANTIOQUIA - HOSPITAL SAN ANTONIO DE BETANIA", nit_entidad := "890981494"]
indicadores_BD[nombre_entidad =="ANTIOQUIA - E.S.E. HOSPITAL SAN CARLOS CAÑASGORDAS", nit_entidad := "890980784"]
indicadores_BD[nombre_entidad =="ANTIOQUIA - E.S.E. HOSPITAL SAN JUAN DE DIOS DE YARUMAL", nit_entidad := "890981726"]
indicadores_BD[nombre_entidad =="ANTIOQUIA - E.S.E. HOSPITAL SANTA ISABEL DE SAN PEDRO DE LOS MILAGROS", nit_entidad := "800014405"]
indicadores_BD[nombre_entidad =="ARAUCA - HOSPITAL SAN VICENTE DE ARAUCA", nit_entidad := "800218979"]
indicadores_BD[nombre_entidad =="BOLÍVAR - EMPRESA SOCIAL DEL ESTADO CENTRO DE SALUD CON CAMAS - PEÑÓN", nit_entidad := "806011087"]
indicadores_BD[nombre_entidad =="CALDAS - CENTRO DE SALUD DE NORCASIA", nit_entidad := "810000912"]
indicadores_BD[nombre_entidad =="CALDAS - HOSPITAL DEPARTAMENTAL SANTA SOFIA DE CALDAS", nit_entidad := "890801099"]
indicadores_BD[nombre_entidad =="CASANARE - E.S.E. HOSPITAL DE YOPAL", nit_entidad := "891855029"]
indicadores_BD[nombre_entidad =="HUILA - E.S.E. CENTRO DE SALUD SAN JUAN DE DIOS - EL PITAL", nit_entidad := "813006877"]
indicadores_BD[nombre_entidad =="NARIÑO - E.S.E. HOSPITAL GUACHUCAL", nit_entidad := "837000286"]
indicadores_BD[nombre_entidad =="NARIÑO - E.S.E. HOSPITAL SAN ANDRÉS DE TUMACO", nit_entidad := "800179870"]
indicadores_BD[nombre_entidad =="NARIÑO - E.S.E. HOSPITAL DEPARTAMENTAL DE NARIÑO", nit_entidad := "891200528"]
indicadores_BD[nombre_entidad =="QUINDÍO - HOSPITAL DEPARTAMENTAL UNIVERSITARIO SAN JUAN DE DIOS DEL QUINDÍO", nit_entidad := "800000118"]
indicadores_BD[nombre_entidad =="RISARALDA - E.S.E. HOSPITAL SAN VICENTE DE PAÚL - APÍA", nit_entidad := "891409017"]
indicadores_BD[nombre_entidad =="RISARALDA - E.S.E. HOSPITAL SAN JOSÉ DE BELÉN DE UMBRÍA", nit_entidad := "891408918"]
indicadores_BD[nombre_entidad =="RISARALDA - HOSPITAL UNIVERSITARIO SAN JORGE DE PEREIRA", nit_entidad := "800231235"]
indicadores_BD[nombre_entidad =="SANTANDER - E.S.E. HOSPITAL DE MACARAVITA", nit_entidad := "804008207"]
indicadores_BD[nombre_entidad =="SANTANDER - E.S.E. HOSPITAL SAN ANTONIO DE CERRITO", nit_entidad := "804013228"]
indicadores_BD[nombre_entidad =="TOLIMA - E.S.E. HOSPITAL SANTO DOMINGO - CASABIANCA", nit_entidad := "800031724"]
indicadores_BD[nombre_entidad =="TOLIMA - E.S.E. HOSPITAL SAN JUAN BAUTISTA - CHAPARRAL", nit_entidad := "890701459"]
indicadores_BD[nombre_entidad =="VALLE DEL CAUCA - HOSPITAL SAN RAFAEL DE ZARZAL", nit_entidad := "891900441"]
indicadores_BD[nombre_entidad =="VALLE DEL CAUCA - E.S.E. HOSPITAL SAGRADA FAMILIA DE TORO", nit_entidad := "891900361"]
indicadores_BD[nombre_entidad =="VALLE DEL CAUCA - E.S.E. HOSPITAL UNIVERSITARIO DEL VALLE EVARISTO GARCÍA", nit_entidad := "890303461"]
indicadores_BD[nombre_entidad =="VALLE DEL CAUCA - HOSPITAL MARIO CORREA RENGIFO DE CALI", nit_entidad := "890399047"]
indicadores_BD[nombre_entidad =="VALLE DEL CAUCA - HOSPITAL SIQUIÁTRICO UNIVERSITARIO SAN ISIDRO", nit_entidad := "890304155"]
```



Prueba de unión supersalud_2015 con indicadores_bd
```{r}
prueba_bd <- indicadores_BD[, 1:12]

prueba_bd <- merge(x = prueba_bd,
                   y = supersalud_calidad_20151,
                   by.x = "nit_entidad",
                   by.y = "nit_ips",
                   all.x = TRUE,
                   all.y = FALSE) %>% 
  dplyr::select(-prestadora)
```

union verdadera con indicadoes_bd

```{r}
indicadores_BD <- merge(x = indicadores_BD,
                        y = supersalud_calidad_20151,
                        by.x = "nit_entidad",
                        by.y = "nit_ips",
                        all.x = TRUE,
                        all.y = FALSE) %>% 
  dplyr::select(-prestadora)

# contra los nas
sapply(indicadores_BD, function(x) sum(is.na(x)))

# Cambiar los NAs por la media de su columna
indicadores_BD<-as.data.frame(indicadores_BD)
columnas_numericas <- which(sapply(indicadores_BD, is.numeric))
cols_mean <- rep(NA, ncol(indicadores_BD))
cols_mean[columnas_numericas] <- colMeans(indicadores_BD[, columnas_numericas], na.rm = TRUE)

for (x in columnas_numericas) {
  indicadores_BD[is.na(indicadores_BD[,x]), x] <- cols_mean[x]
}

# escribir el .csv
write.csv(indicadores_BD, file = "indicadores_BD.csv", row.names = TRUE)
```


# Prueba cercanos a mínima cuantía y final de año


```{r}
head(SECOP_I)
```


```{r}
SECOP_I %>% count(regimen_contratacion)
datatable(SECOP_I %>% count(tipo_contrato, tipo_proceso) %>% arrange(desc(n)))
```


```{r}
datatable(SECOP_I %>% count(regimen_contratacion, tipo_proceso))
#consultas iniciales sobre secop_i

datatable(SECOP_I %>% count(causa_otras_formas_contr_directa) %>% arrange(desc(n)))

#ver cuántoss minima cuantía hay
datatable(SECOP_I %>% count(tipo_proceso) %>% arrange(desc(n)))

#ver calcular mínima cuantía para cada nivel, hospital, municipio y depto

#correlación entre minima cuantía y contratación directaa

# calculo de la cantidad y propoción de contratos cercanos a fin de año
# calculo de la cantidad y proporción de contratos en las fechas de ley de garantías
```

## ver calcular mínima cuantía para cada nivel, hospital, municipio y depto

Crear columna de deptos

```{r}
  # Con este parte del codigo extraigo el departamento de ejecución
depto_entidad <- str_sub(string = SECOP_I$municipio_ejecucion, 
               start = 1L, 
               end = str_locate(string = SECOP_I$municipio_ejecucion, pattern = "-")[,1]-2)

SECOP_I$departamento_ejecucion <- depto_entidad
```

hacer la tabla, los datos


### Departamentos

```{r}
#departamentos
total_contratos <- SECOP_I %>% 
  group_by(departamento_ejecucion) %>% 
  summarise(contratos = n(),
            valor_contratos = sum(valor_total_con_adiciones),
            adiciones = sum(valor_adiciones)) 

total_contratos_directos <- secop_directa %>%
  group_by(departamento_ejecucion) %>% 
  summarise(contratos_directos = n(),
            adiciones_directa = sum(valor_adiciones))

deptos <- merge(total_contratos,
                total_contratos_directos,
                by = "departamento_ejecucion",
                all.y = TRUE) %>% 
  mutate(prop_directa = as.numeric(sprintf("%.2f", 
                                (contratos_directos / contratos)*100)))

# Función de cambio de los NA por ceros
cambio_na = function(x){
  ifelse(is.na(x),0,x)
}

## ADICIONES
contratos_adiciones <- SECOP_I %>% 
  filter(valor_adiciones > 0) %>% 
  count(departamento_ejecucion) %>% 
  rename("contratos_adiciones" = n)

contratos_adiciones_directa <- secop_directa %>% 
  filter(valor_adiciones > 0) %>%
  count(departamento_ejecucion) %>% 
  rename("contratos_adiciones_dir" = n)

deptos_adiciones <- merge(contratos_adiciones,
                          contratos_adiciones_directa,
                          all.x = TRUE) %>% 
  mutate(prop_cont_dir_adic = as.numeric(sprintf("%.2f",
                                                (contratos_adiciones_dir / contratos_adiciones)*100)))

# Cambiar nos NA por ceros
deptos_adiciones <- data.frame( sapply(deptos_adiciones, cambio_na) )

# convertir a  numércias las columnas 
#deptos[, 2:ncol(deptos)] <- as.numeric(deptos[, 2:ncol(deptos)])
#deptos_adiciones$contratos_adiciones <- as.numeric(deptos_adiciones$contratos_adiciones)
#deptos_adiciones$contratos_adiciones_dir <- as.numeric(deptos_adiciones$contratos_adiciones_dir)
#deptos_adiciones$prop_cont_dir_adic <- as.numeric(deptos_adiciones$prop_cont_dir_adic)

# agregar las adiciones a la tabla de informacion departamental
deptos <- merge(deptos,
                deptos_adiciones,
                by = "departamento_ejecucion",
                all.x = TRUE)

## MÍNIMA CUANTÍA
minima_cuantia <- SECOP_I %>% 
  filter(tipo_proceso == "Contratación Mínima Cuantía") %>% 
  group_by(departamento_ejecucion) %>% 
  summarise(contratos_minima_cuantia = n(),
            valor_contratos_minima_cuantia = sum(valor_total_con_adiciones),
            adiciones_minima_cuantia = sum(valor_adiciones))

# agregar la mínima cuantía a la info departamental
deptos <- merge(deptos,
               minima_cuantia,
               by = "departamento_ejecucion",
               all.x = TRUE)

# Cambiar nos NA por ceros
deptos <- data.frame( sapply(deptos, cambio_na) )

# pasar a numérico las variables que están como char
deptos[, 2:ncol(deptos)] <- setNames(data.frame(lapply(deptos[, 2:ncol(deptos)], as.numeric)), 
                        colnames(deptos[, 2:ncol(deptos_adiciones)]))

# calcular porcentajes de mínima cuantía
deptos <- deptos %>% 
    mutate(prop_contr_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (contratos_minima_cuantia / contratos)*100)),
           prop_val_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (valor_contratos_minima_cuantia / valor_contratos)*100)),
           prop_dir_adic = as.numeric(sprintf("%.2f", 
                                           (adiciones_directa / adiciones)*100)))

# Cambiar nos NA por ceros
deptos <- data.frame( sapply(deptos, cambio_na) )

# pasar a numérico las variables que están como char
deptos[, 2:ncol(deptos)] <- setNames(data.frame(lapply(deptos[, 2:ncol(deptos)], as.numeric)), 
                        colnames(deptos[, 2:ncol(deptos_adiciones)]))

sum(sapply(deptos, is.numeric))

# crear el vector que determina el orden en que quiero ver las variables
orden_depto <- c("departamento_ejecucion",
                 "contratos",
                 "contratos_directos",
                 "prop_directa",
                 "contratos_adiciones",
                 "contratos_adiciones_dir",
                 "prop_cont_dir_adic",
                 "contratos_minima_cuantia",
                 "prop_contr_minima_cuantia",
                 "valor_contratos",
                 "adiciones",
                 "adiciones_directa",
                 "prop_dir_adic",
                 "valor_contratos_minima_cuantia",
                 "adiciones_minima_cuantia",
                 "prop_val_minima_cuantia")

# ordenar la tabla de acuerdo a como se quiere
deptos <- deptos %>% 
              dplyr::select(all_of(orden_depto))

# eliminar registro de San Andrés, providencia y santa catalina, otros paises y Colombia
deptos <- deptos[deptos$departamento_ejecucion != "San Andrés, Providencia y Santa Catalina", ]
deptos <- deptos[deptos$departamento_ejecucion != "Otros Paises", ]
deptos <- deptos[deptos$departamento_ejecucion != "Colombia", ]


# LISTO ESTO POR DEPARTAMENTOS
```

#### Ver el problema que había con lo de la mínima cuantía en deptos

```{r}
head(SECOP_I)
sum(indicadores_bd_td$indba_contratos_minima_cuantia_dto)
498867
sum(indicadores_gen$contratos_minima_cuantia_depto)
403616
sum(indicadores_bd_td$indba_contratos_minima_cuantia_hos)
5300
sum(indicadores_gen$contratos_minima_cuantia_hos)
5015
sum(deptos$contratos)
1337876
sum(deptos_2$contratos)
1335158
sum(deptos$contratos)-336-1
1337539
sum(deptos$contratos)-2717-1
1335158

95251

SECOP_I %>% filter(departamento_entidad == "Vaupés") %>% count(nombre_entidad)

indicadores_gen %>% group_by(departamento_entidad) %>% summarise(total = n()) %>% arrange(desc(total))

indicadores_gen %>% group_by(departamento_entidad) %>% summarise(total = sum(contratos_minima_cuantia_depto)) %>% arrange(desc(total))

indicadores_gen %>% filter(departamento_entidad == "Antioquia") %>% dplyr::select( indba_total_contratos, contratos_minima_cuantia_depto) %>% arrange(desc(indba_total_contratos))

```

```{r}
indicadores_bd_td %>% group_by(departamento_entidad) %>% summarise(total = n()) %>% arrange(desc(total))

indicadores_bd_td %>% group_by(departamento_entidad) %>% summarise(total = sum(indba_contratos_minima_cuantia_dto)) %>% arrange(desc(total))

indicadores_bd_td %>% filter(departamento_entidad == "Antioquia") %>% dplyr::select(nombre_entidad, indba_total_contratos, indba_contratos_minima_cuantia_dto) %>% arrange(desc(indba_total_contratos))

```



### Municipios

Datos

```{r}
total_contratos <- SECOP_I %>% 
  group_by(depto_mun) %>% 
  summarise(contratos = n(),
            valor_contratos = sum(valor_total_con_adiciones),
            adiciones = sum(valor_adiciones)) 

total_contratos_directos <- secop_directa %>%
  group_by(depto_mun) %>% 
  summarise(contratos_directos = n(),
            adiciones_directa = sum(valor_adiciones))

municipios <- merge(total_contratos,
                total_contratos_directos,
                by = "depto_mun",
                all.x = TRUE) %>% 
  mutate(prop_directa = as.numeric(sprintf("%.2f", 
                                (contratos_directos / contratos)*100)))

## ADICIONES
contratos_adiciones <- SECOP_I %>% 
  filter(valor_adiciones > 0) %>% 
  count(depto_mun) %>% 
  rename("contratos_adiciones" = n)

contratos_adiciones_directa <- secop_directa %>% 
  filter(valor_adiciones > 0) %>%
  count(depto_mun) %>% 
  rename("contratos_adiciones_dir" = n)

municipios_adiciones <- merge(contratos_adiciones,
                          contratos_adiciones_directa,
                          all.x = TRUE) %>% 
  mutate(prop_cont_dir_adic = as.numeric(sprintf("%.2f",
                                                (contratos_adiciones_dir / contratos_adiciones)*100)))

# Función de cambio de los NA por ceros
cambio_na = function(x){
  ifelse(is.na(x),0,x)
}

# Cambiar nos NA por ceros
municipios_adiciones <- data.frame( sapply(municipios_adiciones, cambio_na) )

# convertir a  numércias las columnas 
#deptos[, 2:ncol(deptos)] <- as.numeric(deptos[, 2:ncol(deptos)])
#deptos_adiciones$contratos_adiciones <- as.numeric(deptos_adiciones$contratos_adiciones)
#deptos_adiciones$contratos_adiciones_dir <- as.numeric(deptos_adiciones$contratos_adiciones_dir)
#deptos_adiciones$prop_cont_dir_adic <- as.numeric(deptos_adiciones$prop_cont_dir_adic)

# agregar las adiciones a la tabla de informacion departamental
municipios <- merge(municipios,
                municipios_adiciones,
                by = "depto_mun",
                all.x = TRUE)

## MÍNIMA CUANTÍA
minima_cuantia <- SECOP_I %>% 
  filter(tipo_proceso == "Contratación Mínima Cuantía") %>% 
  group_by(depto_mun) %>% 
  summarise(contratos_minima_cuantia = n(),
            valor_contratos_minima_cuantia = sum(valor_total_con_adiciones),
            adiciones_minima_cuantia = sum(valor_adiciones))

# agregar la mínima cuantía a la info departamental
municipios <-merge(municipios,
               minima_cuantia,
               by = "depto_mun",
               all.x = TRUE)

# Cambiar nos NA por ceros
municipios <- data.frame( sapply(municipios, cambio_na) )

# pasar a numérico las variables que están como char
municipios[, 2:ncol(municipios)] <- setNames(data.frame(lapply(municipios[, 2:ncol(municipios)], as.numeric)), 
                        colnames(municipios[, 2:ncol(municipios_adiciones)]))

sum(sapply(municipios, is.numeric))

# calcular porcentajes de mínima cuantía
municipios <- municipios %>% 
    mutate(prop_contr_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (contratos_minima_cuantia / contratos)*100)),
           prop_val_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (valor_contratos_minima_cuantia / valor_contratos)*100)),
           prop_dir_adic = as.numeric(sprintf("%.2f", 
                                           (adiciones_directa / adiciones)*100)))

# Cambiar nos NA por ceros
municipios <- data.frame( sapply(municipios, cambio_na) )

# pasar a numérico las variables que están como char
municipios[, 2:ncol(municipios)] <- setNames(data.frame(lapply(municipios[, 2:ncol(municipios)], as.numeric)), 
                        colnames(municipios[, 2:ncol(municipios_adiciones)]))

sum(sapply(deptos, is.numeric))

# crear el vector que determina el orden en que quiero ver las variables
  orden_mun <- c("depto_mun",
                 "contratos",
                 "contratos_directos",
                 "prop_directa",
                 "contratos_adiciones",
                 "contratos_adiciones_dir",
                 "prop_cont_dir_adic",
                 "contratos_minima_cuantia",
                 "prop_contr_minima_cuantia",
                 "valor_contratos",
                 "adiciones",
                 "adiciones_directa",
                 "prop_dir_adic",
                 "valor_contratos_minima_cuantia",
                 "adiciones_minima_cuantia",
                 "prop_val_minima_cuantia")

# ordenar la tabla de acuerdo a como se quiere
municipios <- municipios %>% 
              dplyr::select(all_of(orden_mun))

# LISTO ESTO POR MUNICIPIOS
sapply(municipios, function(x) sum(is.na(x)))
```

### Entidades hospitales

```{r}
total_contratos <- SECOP_I %>% 
  group_by(nombre_entidad, depto_mun, departamento_entidad) %>% 
  summarise(contratos = n(),
            valor_contratos = sum(valor_total_con_adiciones),
            adiciones = sum(valor_adiciones)) 

total_contratos_directos <- secop_directa %>%
  group_by(nombre_entidad) %>% 
  summarise(contratos_directos = n(),
            adiciones_directa = sum(valor_adiciones))

hospitales <- merge(total_contratos,
                total_contratos_directos,
                by = "nombre_entidad",
                all.x = TRUE) %>% 
  mutate(prop_directa = as.numeric(sprintf("%.2f", 
                                (contratos_directos / contratos)*100)))

## ADICIONES
contratos_adiciones <- SECOP_I %>% 
  filter(valor_adiciones > 0) %>% 
  count(nombre_entidad) %>% 
  rename("contratos_adiciones" = n)

contratos_adiciones_directa <- secop_directa %>% 
  filter(valor_adiciones > 0) %>%
  count(nombre_entidad) %>% 
  rename("contratos_adiciones_dir" = n)

hospitales_adiciones <- merge(contratos_adiciones,
                          contratos_adiciones_directa,
                          by = "nombre_entidad",
                          all.x = TRUE) %>% 
  mutate(prop_cont_dir_adic = as.numeric(sprintf("%.2f",
                                                (contratos_adiciones_dir / contratos_adiciones)*100)))

# Función de cambio de los NA por ceros
cambio_na = function(x){
  ifelse(is.na(x),0,x)
}

# Cambiar nos NA por ceros
hospitales_adiciones <- data.frame( sapply(hospitales_adiciones, cambio_na) )

# convertir a  numércias las columnas 
#deptos[, 2:ncol(deptos)] <- as.numeric(deptos[, 2:ncol(deptos)])
#deptos_adiciones$contratos_adiciones <- as.numeric(deptos_adiciones$contratos_adiciones)
#deptos_adiciones$contratos_adiciones_dir <- as.numeric(deptos_adiciones$contratos_adiciones_dir)
#deptos_adiciones$prop_cont_dir_adic <- as.numeric(deptos_adiciones$prop_cont_dir_adic)

# agregar las adiciones a la tabla de informacion departamental
hospitales <- merge(hospitales,
                hospitales_adiciones,
                by = "nombre_entidad",
                all.x = TRUE)

## MÍNIMA CUANTÍA
minima_cuantia <- SECOP_I %>% 
  filter(tipo_proceso == "Contratación Mínima Cuantía") %>% 
  group_by(nombre_entidad) %>% 
  summarise(contratos_minima_cuantia = n(),
            valor_contratos_minima_cuantia = sum(valor_total_con_adiciones),
            adiciones_minima_cuantia = sum(valor_adiciones))

# agregar la mínima cuantía a la info departamental
hospitales <-merge(hospitales,
               minima_cuantia,
               by = "nombre_entidad",
               all.x = TRUE)

# Cambiar nos NA por ceros
hospitales <- data.frame( sapply(hospitales, cambio_na) )

# pasar a numérico las variables que están como char
hospitales[, 4:ncol(hospitales)] <- setNames(data.frame(lapply(hospitales[, 4:ncol(hospitales)], as.numeric)), 
                        colnames(hospitales[, 4:ncol(hospitales_adiciones)]))

sum(sapply(hospitales, is.numeric))

# calcular porcentajes de mínima cuantía
hospitales <- hospitales %>% 
    mutate(prop_contr_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (contratos_minima_cuantia / contratos)*100)),
           prop_val_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (valor_contratos_minima_cuantia / valor_contratos)*100)),
           prop_dir_adic = as.numeric(sprintf("%.2f", 
                                           (adiciones_directa / adiciones)*100)))

# Cambiar nos NA por ceros
hospitales <- data.frame( sapply(hospitales, cambio_na) )

# pasar a numérico las variables que están como char
hospitales[, 4:ncol(hospitales)] <- setNames(data.frame(lapply(hospitales[, 4:ncol(hospitales)], as.numeric)), 
                        colnames(hospitales[, 4:ncol(hospitales_adiciones)]))

sum(sapply(deptos, is.numeric))

# crear el vector que determina el orden en que quiero ver las variables
  orden_hos <- c("nombre_entidad",
                 "departamento_entidad",
                 "depto_mun",
                 "contratos",
                 "contratos_directos",
                 "prop_directa",
                 "contratos_adiciones",
                 "contratos_adiciones_dir",
                 "prop_cont_dir_adic",
                 "contratos_minima_cuantia",
                 "prop_contr_minima_cuantia",
                 "valor_contratos",
                 "adiciones",
                 "adiciones_directa",
                 "prop_dir_adic",
                 "valor_contratos_minima_cuantia",
                 "adiciones_minima_cuantia",
                 "prop_val_minima_cuantia")

# ordenar la tabla de acuerdo a como se quiere
hospitales <- hospitales %>% 
              dplyr::select(all_of(orden_hos))

# LISTO ESTO POR HOSPITALES
```

### Unir los indicadores por departamentos y municipios a los hospitales (entidades)

```{r}
#modificar nombres de columnas de cada taba
#depto
orden_depto <- paste("indba", orden_depto, "dto", sep = "_")
names(deptos) <- orden_depto

#municipios
orden_mun <- paste("indba", orden_mun, "mun", sep = "_")
names(municipios) <- orden_mun

#hospitales
orden_hos <- paste("indba", orden_hos, "hos", sep = "_")
names(hospitales) <- orden_hos

# unir los municipios a los hospitales
entidades <- merge(hospitales, municipios, 
                   by.x = "indba_depto_mun_hos",
                   by.y = "indba_depto_mun_mun",
                   all.x = TRUE)

# unir los departamentos a los hospitales
entidades <- merge(entidades, deptos,
                   by.x = "indba_departamento_entidad_hos",
                   by.y = "indba_departamento_ejecucion_dto",
                   all.x = TRUE)

#entidades$departamento_entidad_hos <- NULL

#ver si hay NAs
sapply(entidades, function(x) sum(is.na(x)))
```

## Cercanos a fin de año

```{r}
# se pasaron las fechas a año
SECOP_I$fecha_cargue_secop <- as.Date(SECOP_I$fecha_cargue_secop, "%m/%d/%y")
head(SECOP_I)
```

Cantidad de contratos cercanos a fin de año:  Cuál es lel tipo de proceso más común los fines de año en secop normal?

```{r}
SECOP_I %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(tipo_proceso) %>% 
  arrange(desc(n))
#  filter(between(fecha_firma_contrato, as.Date("12-01-2015"), as.Date("31-01-2015"))) %>% 

# departamentos
deptos_finyr <- merge(
SECOP_I %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(departamento_entidad) %>% 
  arrange(desc(n)),
secop_directa %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(departamento_entidad) %>% 
  arrange(desc(n)),
by = "departamento_entidad",
all.x = TRUE
) %>% rename("indba_contr_finyr_dto" = "n.x",
             "indba_contr_finyr_directa_dto" = "n.y") 

# Cambiar nos NA por ceros
deptos_finyr <- data.frame(sapply(deptos_finyr, cambio_na))

# pasar a numérico las variables que están como char
deptos_finyr[, 2:ncol(deptos_finyr)] <- setNames(data.frame(lapply(deptos_finyr[, 2:ncol(deptos_finyr)], as.numeric)), 
                        colnames(deptos_finyr[, 2:ncol(deptos_finyr)]))

deptos_finyr <-
  deptos_finyr %>% 
  mutate(indba_prop_contr_finyr_dto = as.numeric(sprintf("%.2f", 
                                                     (indba_contr_finyr_directa_dto / indba_contr_finyr_dto)*100))) 

#hospitales
SECOP_I %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(nombre_entidad) %>% 
  arrange(desc(n))

# departamentos
hospitales_finyr <- 
  merge(
SECOP_I %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(nombre_entidad, departamento_entidad) %>% 
  arrange(desc(n)),
secop_directa %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(nombre_entidad) %>% 
  arrange(desc(n)),
by = "nombre_entidad",
all.x = TRUE
) %>% rename("indba_contr_finyr_hos" = "n.x",
             "indba_contr_finyr_directa_hos" = "n.y") 

# Cambiar nos NA por ceros
hospitales_finyr <- data.frame(sapply(hospitales_finyr, cambio_na))

# pasar a numérico las variables que están como char
hospitales_finyr[, 3:ncol(hospitales_finyr)] <- setNames(data.frame(lapply(hospitales_finyr[, 3:ncol(hospitales_finyr)], as.numeric)), 
                        colnames(hospitales_finyr[, 3:ncol(hospitales_finyr)]))

hospitales_finyr <-
  hospitales_finyr %>% 
  mutate(indba_prop_contr_finyr_hos = as.numeric(sprintf("%.2f", 
                                                     (indba_contr_finyr_directa_hos / indba_contr_finyr_hos)*100))) 

head(hospitales_finyr)
```


merge entre finyr deptos y hospitales

```{r}
hospitales_finyr <- merge(hospitales_finyr,
      deptos_finyr,
      by = "departamento_entidad",
      all.x = TRUE) %>% 
  dplyr::select(-departamento_entidad)
```


cuál es lel tipo de proceso más común los fines de año en secop diecta

```{r}
#hospitales
secop_directa %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(nombre_entidad) %>% 
  arrange(desc(n))

# departamentos
secop_directa %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(departamento_entidad) %>% 
  arrange(desc(n))

```


# Intentar merge de entidades (hospitales) con indicadores_bd_td y luego con hospitales_finyr

Entre entidades y indicadores_bd_td

```{r}
# filtrar las columnas deseadas de las entidades
# hacer el merge por nombre de entidad
# correr el random forest

# entidades con indicadores_bt_td
indicadores_bd_td <- merge( indicadores_bd_td,
                            entidades %>% dplyr::select( indba_nombre_entidad_hos,
                                                         indba_contratos_minima_cuantia_hos,
                                                         indba_prop_contr_minima_cuantia_hos,
                                                         indba_valor_contratos_minima_cuantia_hos,
                                                         indba_prop_val_minima_cuantia_hos,
                                                         indba_contratos_minima_cuantia_dto,
                                                         indba_prop_contr_minima_cuantia_dto,
                                                         indba_valor_contratos_minima_cuantia_dto,
                                                         indba_prop_val_minima_cuantia_dto),
                            by.x = "nombre_entidad",
                            by.y = "indba_nombre_entidad_hos",
                            all.x = TRUE )
```

Entre los hospitales_finyr y los indicadores_bd_td

```{r}
indicadores_bd_td <- merge(indicadores_bd_td,
                          hospitales_finyr,
                          by = "nombre_entidad",
                          all.x = TRUE)
```

Ajustar los NAs

```{r}
indicadores_bd_td <- data.frame(sapply(indicadores_bd_td, cambio_na))

# pasar a numérico las variables que están como char
indicadores_bd_td[, 9:ncol(indicadores_bd_td)] <- setNames(data.frame(lapply(indicadores_bd_td[, 9:ncol(indicadores_bd_td)], as.numeric)), 
                        colnames(indicadores_bd_td[, 9:ncol(indicadores_bd_td)]))

head(indicadores_bd_td)

sum(sapply(indicadores_bd_td, is.numeric))

sapply(indicadores_bd_td, function(x) sum(is.na(x)))
```


## Escribir el .csv

```{r}
write.csv(indicadores_bd_td, file = "indicadores_bd_td.csv", row.names = TRUE)
```

## Leer de nuevo los datos porque lo borré sin querer

```{r}
indicadores_bd_td_v2 <- read_delim(file = "indicadores_bd_td_v2.csv", delim = ",")
view(indicadores_bd_td_v2)
```

Teniendo la cantidad de contratos a fin de año se puede calcular la proporción que los contratos a fin de año representan en la totalidad del año

```{r}
indicadores_bd_td %>% mutate(
  indba_prop_contr_finyr_total_hos = (indba_contr_finyr_hos / indba_total_contratos )*100) %>% dplyr::select(nombre_entidad, indba_prop_contr_finyr_total_hos) %>% arrange(desc(indba_prop_contr_finyr_total_hos))


# en la base de datos
indicadores_bd_td <- indicadores_bd_td %>% mutate(
  indba_prop_contr_finyr_total_hos = (indba_contr_finyr_hos / indba_total_contratos )*100)
```

# 2.2. Financiero

Datos filtrados, es decir, este data set contiene solo las variables que se van a utilizar

```{r}
financiero_municipio <- read.csv("TD_ind_finpub_YG.csv", 
                       header = TRUE, 
                       encoding="UTF-8")
```

Renombras las columnas

```{r}
financiero_municipio <- financiero_municipio %>% rename(
  "inf_financiamiento" = "Financiamiento",
  "inf_ind_desemp_fiscal" = "Indicador.de.desempeño.fiscal",
  "inf_ingresos_totales" = "Ingresos.totales",
  "inf_cantidad_proyectos" = "Número.total.de.proyectos",
  "inf_ppa_educacion" = "ppa...Educación",
  "inf_ppa_salud" = "ppa...Salud",
  "inf_regalias_percapita_valor_efec_girado" = "Regalías.per.cápita..Valor.efectivamente.girado.al.municipio.",
  "inf_valor_proyectos" = "Valor.del.número.total.de.proyectos",
  "inf_igpr" = "Índice.de.gestión.de.proyectos.de.regalías..IGPR."
)

# "Índice.de.gestión.de.proyectos.de.regalías..IGPR."
```


Ver cuántos NAs hay por cada columna

```{r}
# Porcentaje de NAs con sapply
sapply(financiero_municipio, function(x) mean(is.na(x)))

# Porcentaje de NAs con apply
apply(is.na(financiero_municipio), 2, mean)

# Función para la Cantidad y porcentaje de NAs por culumna con apply
cantyprop_nas <- function(x){
  cant <- sum(x)
  prop <- mean(x)*100
  return(c(cant, prop))
}

# Aplicar por columna
apply(is.na(financiero_municipio), 2, cantyprop_nas)
```

Eliminar la columna que tiene demasiados NAs (inf_valor_proyectos)

```{r}
#financiero_municipio$inf_valor_proyectos <- NULL
#financiero_municipio$inf_cantidad_proyectos <- NULL

financiero_municipio %>% na.omit() %>% count(codigo_entidad) %>% arrange(desc(n))
```
Crear las columnas como las necesito: que contenga el nombre del indicador, el año el indicador y si es de municipio o de departamento.

```{r}
financiero_municipio <- financiero_municipio %>% 
  pivot_longer(cols = !c(codigo_entidad, anno), names_to = "indicador", values_to = "valor") %>%
  unite(indicador_year, "indicador", "anno", sep = "_") %>% 
  na.omit()
```

Agregar el indicativo de que el indicador es para el municipio

```{r}
financiero_municipio$indicador_year <- str_c(financiero_municipio$indicador_year, "mun", sep = "_")

head(financiero_municipio)
```

Pasar los indicadores a columnas de nuevo

```{r}
financiero_municipio <- financiero_municipio %>% 
  pivot_wider(names_from = indicador_year, values_from = valor)
```

Ver de nuevo la cantidad de nas

```{r}
# Aplicar por columna
apply(is.na(financiero_municipio), 2, cantyprop_nas)
```

Eliminar la cantidad de proyectos faltante superior al 40%

```{r}
financiero_municipio$inf_cantidad_proyectos_2014_mun <- NULL
#financiero_municipio$inf_cantidad_proyectos_2015_mun <- NULL
financiero_municipio$inf_valor_proyectos_2017_mun <- NULL
financiero_municipio$inf_valor_proyectos_2014_mun <- NULL
financiero_municipio$inf_valor_proyectos_2016_mun <- NULL
```

Hacer el merge con los indicaodres_bd_td

```{r}
#financiero_municipio$codigo_entidad <- as.character(financiero_municipio$codigo_entidad)
#indicadores_bd_td <- indicadores_bd_td[, 1:113]
indicadores_bd_td <- merge(indicadores_bd_td,
                           financiero_municipio,
                           by.x = "cod_entidad",
                           by.y = "codigo_entidad", 
                           all.x = TRUE)
```

ver los NAs

```{r}
apply(is.na(indicadores_bd_td), 2, cantyprop_nas)
```


Reemplazar los nas por la media de su columna

```{r}
indicadores_bd_td <-as.data.frame(indicadores_bd_td)
# cuáles columnas son numéricas
columnas_numericas <- which(sapply(indicadores_bd_td, is.numeric))
cols_mean <- rep(NA, ncol(indicadores_bd_td))
cols_mean[columnas_numericas] <- colMeans(indicadores_bd_td[, columnas_numericas], na.rm = TRUE)

# reemplaar los NA
for (x in columnas_numericas) {
  indicadores_bd_td[is.na(indicadores_bd_td[,x]), x] <- cols_mean[x]
}

apply(is.na(indicadores_bd_td), 2, cantyprop_nas)

```

Random

```{r}
# de ete sí se eliminan los na
financiero_municipio[!is.na(financiero_municipio$Indicador.de.desempeño.fiscal), ] 

# de ete sí se eliminan los na
financiero_municipio[!is.na(financiero_municipio$Número.total.de.proyectos), ] %>% count(codigo_entidad) %>% arrange(desc(n))

# se elimina esta columna
financiero_municipio[!is.na(financiero_municipio$Valor.del.número.total.de.proyectos), ] %>% count(codigo_entidad) %>% arrange(desc(n))

# de ete sí se eliminan los na
financiero_municipio[!is.na(financiero_municipio$Indicador.de.desempeño.fiscal), ] %>% count(codigo_entidad) %>% arrange(desc(n))

# ver cuántos datos hay eliminando los NAS de las columnas seleccionadas
financiero_municipio[!is.na(c(financiero_municipio$Indicador.de.desempeño.fiscal,
                            financiero_municipio$Número.total.de.proyectos,
                            financiero_municipio$Indicador.de.desempeño.fiscal)), ] %>% count(codigo_entidad) %>% arrange(desc(n))
```
