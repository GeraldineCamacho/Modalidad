---
title: "Union indicadores por anios"
author: "Yilber Alejandro Erazo Bolaños"
date: "21/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

librerías

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(readxl)
library(stringr)
```

# Ajustes iniciales

## Indicadores

Lectura de los datos iniciales de los indicadores

```{r}
indicadores <- read_delim("Indicadores_Final.csv", ";")
```

Ajustes a la base de dato de indicadores

```{r}
# Ajustar nombres de algunas entidades territoriales para que coincidad en ambas BDs
indicadores<-as.data.table(indicadores)
indicadores[departamento_entidad=="Bogotá D.C." , departamento_entidad:="Bogotá"]
indicadores[departamento_entidad=="Bogotá" , municipio_entidad:="Bogotá"]
indicadores[departamento_entidad=="Norte De Santander", departamento_entidad:="Norte de Santander"]
# Generar una nueva columna con el nombre del departamento-municipio
indicadores<- unite(indicadores, depto_mun, c("departamento_entidad", "municipio_entidad"), sep = "-", remove = FALSE)
```

Ajuste manual de registros críticos
Reemplazar los datos de indicadores como los nombres de economiatd
cCaso especial: No existe en economíatd Sucre-Sincé , Bolívar-Santa Rosa de Lima

```{r}
indicadores[depto_mun=="Cauca-Paez/Belalcazar" , municipio_entidad:="Paéz"]
indicadores[depto_mun=="Boyacá-Chíquiza (San Pedro de Iguaque)" , municipio_entidad:="Chíquiza"]
indicadores[depto_mun=="Cesar-Manaure Balcon del Cesar" , municipio_entidad:="Manaure"]
indicadores[depto_mun=="Cauca-López de Micay" , municipio_entidad:="López"]
indicadores[depto_mun=="Huila-El Pital" , municipio_entidad:="Pital"]
indicadores[depto_mun=="Antioquia-Carolina del Príncipe" , municipio_entidad:="Carolina"]
indicadores[depto_mun=="Nariño-Cuaspud/Carlosama" , municipio_entidad:="Cuaspud"]
indicadores[depto_mun=="Norte de Santander-San José de Cúcuta" , municipio_entidad:="Cúcuta"]
indicadores[depto_mun=="Tolima-El Espinal" , municipio_entidad:="Espinal"]
indicadores[depto_mun=="Putumayo-San Miguel (La Dorada)" , municipio_entidad:="San Miguel"]
indicadores[depto_mun=="Antioquia-El Peñol" , municipio_entidad:="Peñol"]
indicadores[depto_mun=="Putumayo-San Miguel de Mocoa" , municipio_entidad:="Mocoa"]
indicadores[depto_mun=="Sucre-Toluviejo" , municipio_entidad:="Tolú Viejo"]
indicadores[depto_mun=="Boyacá-Gameza" , municipio_entidad:="Gámeza"]
indicadores[depto_mun=="Bolívar-San Estanislao de Kostka" , municipio_entidad:="San Estanislao"]
indicadores[depto_mun=="Nariño-Roberto Payán/San José" , municipio_entidad:="Roberto Payán"]
indicadores[depto_mun=="Putumayo-Valle del Guamuez/La Hormiga" , municipio_entidad:="Valle del Guamuez"]
indicadores[depto_mun=="Tolima-San Sebastian de Mariquita" , municipio_entidad:="San Sebastián de Mariquita"]
indicadores[depto_mun=="Cundinamarca-Caqueza" , municipio_entidad:="Cáqueza"]
indicadores[depto_mun=="Tolima-El Guamo" , municipio_entidad:="Guamo"]
indicadores[depto_mun=="Tolima-El Líbano" , municipio_entidad:="Líbano"]
indicadores[depto_mun=="Sucre-Coloso" , municipio_entidad:="Colosó"]
indicadores[depto_mun=="Cauca-Toribio" , municipio_entidad:="Toribío"]
indicadores[depto_mun=="Nariño-San Andres de Tumaco" , municipio_entidad:="San Andrés de Tumaco"]
indicadores[depto_mun=="Antioquia-San Pedro de los Milagros" , municipio_entidad:="San Pedro de Los Milagros"]
indicadores[depto_mun=="Antioquia-Anza" , municipio_entidad:="Anzá"]
indicadores[depto_mun=="Nariño-Consaca" , municipio_entidad:="Consacá"]
indicadores[depto_mun=="Quindío-Calarca" , municipio_entidad:="Calarcá"]
indicadores[depto_mun=="Antioquia-Yolombo" , municipio_entidad:="Yolombó"]
indicadores[depto_mun=="Santander-Lebríja" , municipio_entidad:="Lebrija"]
indicadores[depto_mun=="Cundinamarca-Fomeque" , municipio_entidad:="Fómeque"]
indicadores[depto_mun=="Valle del Cauca-Jamundi" , municipio_entidad:="Jamundí"]
indicadores[depto_mun=="Norte de Santander-Abrego" , municipio_entidad:="Ábrego"]
indicadores[depto_mun=="Atlántico-Campo de la Cruz" , municipio_entidad:="Campo de La Cruz"]
indicadores[depto_mun=="Antioquia-San Pedro de Uraba" , municipio_entidad:="San Pedro de Urabá"]
indicadores[depto_mun=="La Guajira-La Jagua Del Pilar" , municipio_entidad:="La Jagua del Pilar"]
indicadores[depto_mun=="Caquetá-Belén de Los Andaquies" , municipio_entidad:="Belén de Los Andaquíes"]
indicadores[depto_mun=="Magdalena-Sabanas de San Angel" , municipio_entidad:="Sabanas de San Ángel"]
indicadores[depto_mun=="Antioquia-San Andrés de Cuerquia" , municipio_entidad:="San Andrés de Cuerquía"]
indicadores[depto_mun=="Antioquia-San José de la Montaña" , municipio_entidad:="San José de La Montaña"]
```

Reemplazr la columna con el nombre del departamento-municipio

```{r}
indicadores$depto_mun<-NULL
indicadores<- unite(indicadores, depto_mun, c("departamento_entidad", "municipio_entidad"), sep = "-", remove = FALSE)
```


## Economía

Datos iniciales: base de datos completa, tal cual como está en Terridata.

```{r}
economiatd<- read.csv2("TerriData_Economia", 
                       header = TRUE, 
                       encoding="UTF-8", dec = ".")
```

Ajustes de la base de datos

```{r}
### Ajustar los nombres de la base de datos de economía
economiatd<- economiatd %>%
  rename(cod_departamento = "Código.Departamento", 
         departamento = "Departamento", 
         cod_entidad = "Código.Entidad", 
         entidad = "Entidad", 
         dimension = "Dimensión", 
         subcategoria = "Subcategoría", 
         indicador = "Indicador", 
         dato_numerico = "Dato.Numérico", 
         dato_cualitativo = "Dato.Cualitativo", 
         anno = "Año", 
         mes = "Mes", 
         fuente = "Fuente", 
         unidad_medida = "Unidad.de.Medida")
### Filtros
economiatd<- economiatd[!is.na(economiatd$dato_numerico),]
economiatd<- economiatd %>% filter(anno >=2014)
economiatd<- economiatd %>% filter(departamento != "Colombia")
### Generar una nueva columna con el nombre del departamento-municipio
economiatd<- unite(economiatd, depto_mun,
                   c("departamento","entidad"),
                   sep = "-",
                   remove = FALSE)
```

# Unión Terridata

Se seleccionaron 4 categorías de indicadores dentro de la plataforma Terridata, esto debido a que según algunos estudios dichas categorías de indicadores puede tener relación con el fenómeno de la corrupción. Las categorías son:
- Economía
- Educación
- Financiero
- Salud

## Economía

Se seleccionaron los indicadores de 2 subcategorías de las cuáles se tenían suficientes datos (PIB y ) y el Porcentaje del PIB por grandes ramas de actividad económica) y se cree que pueden tener una relación con el tema de estudio, esto de acuerdo a algunas investigaciones hechas por pares y publicadas en algunos artículos como: [Lista de artículos]

### Extraer datos

Por departamentos

```{r}
# Separar datos por departamentos discriminando por años
economia_depto <- economiatd %>% 
  filter( subcategoria == "PIB" | 
            subcategoria == "Porcentaje del PIB por grandes ramas de actividad económica" &
            departamento == entidad, 
          departamento != "Colombia", 
          departamento!= "Bogotá") %>% 
  group_by(cod_departamento, departamento, anno,indicador) %>% 
  dplyr::select(cod_departamento, departamento, anno, indicador, dato_numerico) %>% 
  unite(indicador_annio, c("indicador", "anno"), sep = "_", remove = TRUE)
```

Reemplazar los nombres de los indicadores para eliminar espacios, porcentajes, tildes, comas y hacer los nombres más cortos y entendibles, de tal manera que se pueda pasar el nombre del indicador como coluna.

```{r}
# pasar las mayúsculas a minúsculas
economia_depto$indicador_annio <- tolower(economia_depto$indicador_annio)

# tildes y espacios
economia_depto$indicador_annio <- chartr('ÁÉÍÓÚáéíóú ','AEIOUaeiou_', economia_depto$indicador_annio)

# porcetajes (% y "porcentaje)
economia_depto$indicador_annio <- gsub("%", "perc", economia_depto$indicador_annio)
economia_depto$indicador_annio <- gsub("porcentaje", "perc", economia_depto$indicador_annio)

# eliminar comas
economia_depto$indicador_annio <- gsub(",", "", economia_depto$indicador_annio)
```

Agregar el indicativo del indicador de economía

```{r}
economia_depto$indicador_annio <- str_c("inec", economia_depto$indicador_annio, sep = "_")
```

Pasar las filas de indicador a columnas

```{r}
economia_depto <- economia_depto %>% 
  pivot_wider(names_from = indicador_annio, values_from = dato_numerico) 
```

Unir los indicadores por departamentos a los indicadores de SECOP

```{r}
indicadores_bd_td<- merge(indicadores,
                       economia_depto,
                       by.x= "departamento_entidad",
                       by.y= "departamento",
                       all.x=TRUE)
```

Por municipios

De los municipios se seleccionaron solo 7 indicadores debido a que solo estos 7 contenían suficientes datos para los municipios

```{r}
# Municipios que están en ambas DBs
economiatdmun <- economiatd %>% filter(economiatd$depto_mun %in% indicadores$depto_mun)

#Separar datos por municipios discriminados por años
economia_municipio <- economiatdmun %>%
  filter(   indicador == "Participación del valor agregado municipal en el departamental" |
              indicador == "Porcentaje del valor agregado por actividades económicas - Actividades primarias" |
              indicador == "Porcentaje del valor agregado por actividades económicas - Actividades secundarias" |
              indicador == "Porcentaje del valor agregado por actividades económicas - Actividades terciarias" |
              indicador == "Valor agregado" |
              indicador == "Valor agregado per cápita" |
              indicador == "Valor agregado per cápita como porcentaje del promedio nacional" ) %>% 
  group_by(depto_mun, cod_entidad, anno, indicador) %>% 
  dplyr::select(depto_mun, cod_entidad, anno, indicador, dato_numerico) %>% 
  unite(indicador_annio, c("indicador", "anno"), sep = "_", remove = TRUE)
```

Reemplazar los nombres de los indicadores para eliminar espacios, porcentajes, tildes, comas y hacer los nombres más cortos y entendibles, de tal manera que se pueda pasar el nombre del indicador como coluna.

```{r}
# pasar las mayúsculas a minúsculas
economia_municipio$indicador_annio <- tolower(economia_municipio$indicador_annio)

#guión
economia_municipio$indicador_annio <- gsub(" - ", " ", economia_municipio$indicador_annio)

# tildes y espacios
economia_municipio$indicador_annio <- chartr('ÁÉÍÓÚáéíóú ','AEIOUaeiou_', economia_municipio$indicador_annio)

# porcetajes (% y "porcentaje)
economia_municipio$indicador_annio <- gsub("%", "perc", economia_municipio$indicador_annio)
economia_municipio$indicador_annio <- gsub("porcentaje", "perc", economia_municipio$indicador_annio)

# eliminar comas
economia_municipio$indicador_annio <- gsub(",", "", economia_municipio$indicador_annio)
```

Agregar el indicativo del indicador de economía

```{r}
economia_municipio$indicador_annio <- str_c("inec", economia_municipio$indicador_annio, sep = "_")
```

Pasar las filas de indicador a columnas

```{r}
economia_municipio <- economia_municipio %>% 
  pivot_wider(names_from = indicador_annio, values_from = dato_numerico) 
```

Unir las dos bases de datos de economia 

```{r}
### Unir indicadores_BD general con los indicadores municipio (recordar problema con San Andrés y Bogotá)
indicadores_bd_td <- merge(indicadores_bd_td,
                       economia_municipio,
                       by="depto_mun",
                       all.x= FALSE,
                       all.y=TRUE)
```

cambiar nombre de indidacor de corrupción

```{r}
indicadores_bd_td <- indicadores_bd_td %>% 
  rename("indba_riesgo_corrupcion" = "ind_riesgo_corrupcion")
```


### Procesamiento final economía unida

Ordenr el nombre de las columnas

```{r}
nombres <- c("nombre_entidad", "nit_entidad" , "orden_entidad", 
             "departamento_entidad", "cod_departamento",
             "municipio_entidad", "depto_mun","cod_entidad")
indicadores_BD_O1 <- indicadores_bd_td %>% dplyr::select(!all_of(nombres))
nombres_BD <- c(nombres, names(indicadores_BD_O1))
indicadores_bd_td <- indicadores_bd_td %>% dplyr::select(all_of(nombres_BD))
rm(indicadores_BD_O1)
rm(nombres_BD)
```

Cambiar los NAs por la media de su columna

```{r}
indicadores_bd_td <-as.data.frame(indicadores_bd_td)
# cuáles columnas son numéricas
columnas_numericas <- which(sapply(indicadores_bd_td, is.numeric))
cols_mean <- rep(NA, ncol(indicadores_bd_td))
cols_mean[columnas_numericas] <- colMeans(indicadores_bd_td[, columnas_numericas], na.rm = TRUE)

# reemplaar los NA
for (x in columnas_numericas) {
  indicadores_bd_td[is.na(indicadores_bd_td[,x]), x] <- cols_mean[x]
}
```

Contar cuántos valores faltantes hay

```{r}
sapply(indicadores_bd_td, function(x) sum(is.na(x)))
```

# Union externos

Aquí se unen añaden algunos indicadores que no se encontraron en Terridata ni en SECOP, sino que, en fuentes externas

## MDM (Medición del Desempeño Municipal)

```{r}
mdm <- read_excel("Resultados_2018_MDM.xlsx")

### Ajustar nombres
nombres_mdm <- c("cod_entidad", "depto" , "municipio" , "grupo_cap_iniciales",
                 "inmdm_gestion_mov_recursos_mun", "inmdm_gestion_ejec_recursos_mun",
                 "inmdm_gestion_ord_territorial_mun", "inmdm_gobno_abierto_transparencia_mun",
                 "inmdm_puntaje_gestion_mun", "inmdm_puesto_gestion_grupo_capacidades",
                 "inmdm_res_educacion_mun", "inmdm_res_salud_mun", "inmdm_res_servicios_mun",
                 "inmdm_res_seguridad_mun", "inmdm_ind_puntaje_res_2017_mun",
                 "inmdm_ind_ppuntaje_res_2018_mun", "inmdm_ajuste_por_resultados_mun",
                 "inmdm_puesto_resultados_grupo_capacidades", "inmdm_puntaje_mdm_2018",
                 "inmdm_puesto_mdm_grupo_capacidades", "inmdm_clasificacion")
names(mdm) <- nombres_mdm
mdm$cod_entidad <- as.numeric(mdm$cod_entidad)

### Seleccionar datos
mdm <- mdm %>% 
  dplyr::select(cod_entidad, inmdm_gestion_mov_recursos_mun, inmdm_gestion_ejec_recursos_mun,
                inmdm_gestion_ord_territorial_mun, inmdm_gobno_abierto_transparencia_mun,
                inmdm_puntaje_gestion_mun,inmdm_ind_ppuntaje_res_2018_mun, inmdm_puntaje_mdm_2018,
                inmdm_clasificacion)

mdm <- mdm %>% mutate(
  inmdm_clasificacion = case_when(inmdm_clasificacion == "Bajo" ~ 1,
                                  inmdm_clasificacion == "Medio" ~ 2,
                                  TRUE ~ 3)
  )
```

Unir el mdm

```{r}
#indicadores_bd_td <- indicadores_bd_td[ , 1:88]

### Agregar MDM a la base de datos de los indicadores
indicadores_bd_td <- merge(indicadores_bd_td,
                           mdm,
                           by = "cod_entidad",
                           all.x = TRUE,
                           all.y = FALSE)
```

escribir base de datos

```{r}
write.csv(indicadores_bd_td, file = "indicadores_bd_td.csv", row.names = TRUE)
```

## Mínima cuantía

Hacer la tabla, los datos

### Departamentos

```{r}
#departamentos
total_contratos <- SECOP_I %>% 
  group_by(departamento_ejecucion) %>% 
  summarise(contratos = n(),
            valor_contratos = sum(valor_total_con_adiciones),
            adiciones = sum(valor_adiciones)) 

total_contratos_directos <- secop_directa %>%
  group_by(departamento_ejecucion) %>% 
  summarise(contratos_directos = n(),
            adiciones_directa = sum(valor_adiciones))

deptos <- merge(total_contratos,
                total_contratos_directos,
                by = "departamento_ejecucion",
                all.y = TRUE) %>% 
  mutate(prop_directa = as.numeric(sprintf("%.2f", 
                                (contratos_directos / contratos)*100)))

## ADICIONES
contratos_adiciones <- SECOP_I %>% 
  filter(valor_adiciones > 0) %>% 
  count(departamento_ejecucion) %>% 
  rename("contratos_adiciones" = n)

contratos_adiciones_directa <- secop_directa %>% 
  filter(valor_adiciones > 0) %>%
  count(departamento_ejecucion) %>% 
  rename("contratos_adiciones_dir" = n)

deptos_adiciones <- merge(contratos_adiciones,
                          contratos_adiciones_directa,
                          all.x = TRUE) %>% 
  mutate(prop_cont_dir_adic = as.numeric(sprintf("%.2f",
                                                (contratos_adiciones_dir / contratos_adiciones)*100)))

# Función de cambio de los NA por ceros
cambio_na = function(x){
  ifelse(is.na(x),0,x)
}

# Cambiar nos NA por ceros
deptos_adiciones <- data.frame( sapply(deptos_adiciones, cambio_na) )

# convertir a  numércias las columnas 
#deptos[, 2:ncol(deptos)] <- as.numeric(deptos[, 2:ncol(deptos)])
#deptos_adiciones$contratos_adiciones <- as.numeric(deptos_adiciones$contratos_adiciones)
#deptos_adiciones$contratos_adiciones_dir <- as.numeric(deptos_adiciones$contratos_adiciones_dir)
#deptos_adiciones$prop_cont_dir_adic <- as.numeric(deptos_adiciones$prop_cont_dir_adic)

# agregar las adiciones a la tabla de informacion departamental
deptos <- merge(deptos,
                deptos_adiciones,
                by = "departamento_ejecucion",
                all.x = TRUE)

## MÍNIMA CUANTÍA
minima_cuantia <- SECOP_I %>% 
  filter(tipo_proceso == "Contratación Mínima Cuantía") %>% 
  group_by(departamento_ejecucion) %>% 
  summarise(contratos_minima_cuantia = n(),
            valor_contratos_minima_cuantia = sum(valor_total_con_adiciones),
            adiciones_minima_cuantia = sum(valor_adiciones))

# Cambiar nos NA por ceros
deptos <- data.frame( sapply(deptos, cambio_na) )

# agregar la mínima cuantía a la info departamental
deptos <-merge(deptos,
               minima_cuantia,
               by = "departamento_ejecucion",
               all.x = TRUE)

# Cambiar nos NA por ceros
deptos <- data.frame( sapply(deptos, cambio_na) )

# pasar a numérico las variables que están como char
deptos[, 2:ncol(deptos)] <- setNames(data.frame(lapply(deptos[, 2:ncol(deptos)], as.numeric)), 
                        colnames(deptos[, 2:ncol(deptos_adiciones)]))

sum(sapply(deptos, is.numeric))

# calcular porcentajes de mínima cuantía
deptos <- deptos %>% 
    mutate(prop_contr_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (contratos_minima_cuantia / contratos)*100)),
           prop_val_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (valor_contratos_minima_cuantia / valor_contratos)*100)),
           prop_dir_adic = as.numeric(sprintf("%.2f", 
                                           (adiciones_directa / adiciones)*100)))

# Cambiar nos NA por ceros
deptos <- data.frame( sapply(deptos, cambio_na) )

# pasar a numérico las variables que están como char
deptos[, 2:ncol(deptos)] <- setNames(data.frame(lapply(deptos[, 2:ncol(deptos)], as.numeric)), 
                        colnames(deptos[, 2:ncol(deptos_adiciones)]))

sum(sapply(deptos, is.numeric))

# crear el vector que determina el orden en que quiero ver las variables
orden_depto <- c("departamento_ejecucion",
                 "contratos",
                 "contratos_directos",
                 "prop_directa",
                 "contratos_adiciones",
                 "contratos_adiciones_dir",
                 "prop_cont_dir_adic",
                 "contratos_minima_cuantia",
                 "prop_contr_minima_cuantia",
                 "valor_contratos",
                 "adiciones",
                 "adiciones_directa",
                 "prop_dir_adic",
                 "valor_contratos_minima_cuantia",
                 "adiciones_minima_cuantia",
                 "prop_val_minima_cuantia")

# ordenar la tabla de acuerdo a como se quiere
deptos <- deptos %>% 
              dplyr::select(all_of(orden_depto))

# eliminar registro de San Andrés, providencia y santa catalina
deptos <- deptos[deptos$departamento_ejecucion != "San Andrés, Providencia y Santa Catalina", ]

# LISTO ESTO POR DEPARTAMENTOS
```

### Municipios

Datos

```{r}
total_contratos <- SECOP_I %>% 
  group_by(depto_mun) %>% 
  summarise(contratos = n(),
            valor_contratos = sum(valor_total_con_adiciones),
            adiciones = sum(valor_adiciones)) 

total_contratos_directos <- secop_directa %>%
  group_by(depto_mun) %>% 
  summarise(contratos_directos = n(),
            adiciones_directa = sum(valor_adiciones))

municipios <- merge(total_contratos,
                total_contratos_directos,
                by = "depto_mun",
                all.y = TRUE) %>% 
  mutate(prop_directa = as.numeric(sprintf("%.2f", 
                                (contratos_directos / contratos)*100)))

## ADICIONES
contratos_adiciones <- SECOP_I %>% 
  filter(valor_adiciones > 0) %>% 
  count(depto_mun) %>% 
  rename("contratos_adiciones" = n)

contratos_adiciones_directa <- secop_directa %>% 
  filter(valor_adiciones > 0) %>%
  count(depto_mun) %>% 
  rename("contratos_adiciones_dir" = n)

municipios_adiciones <- merge(contratos_adiciones,
                          contratos_adiciones_directa,
                          all.x = TRUE) %>% 
  mutate(prop_cont_dir_adic = as.numeric(sprintf("%.2f",
                                                (contratos_adiciones_dir / contratos_adiciones)*100)))

# Función de cambio de los NA por ceros
cambio_na = function(x){
  ifelse(is.na(x),0,x)
}

# Cambiar nos NA por ceros
municipios_adiciones <- data.frame( sapply(municipios_adiciones, cambio_na) )

# convertir a  numércias las columnas 
#deptos[, 2:ncol(deptos)] <- as.numeric(deptos[, 2:ncol(deptos)])
#deptos_adiciones$contratos_adiciones <- as.numeric(deptos_adiciones$contratos_adiciones)
#deptos_adiciones$contratos_adiciones_dir <- as.numeric(deptos_adiciones$contratos_adiciones_dir)
#deptos_adiciones$prop_cont_dir_adic <- as.numeric(deptos_adiciones$prop_cont_dir_adic)

# agregar las adiciones a la tabla de informacion departamental
municipios <- merge(municipios,
                municipios_adiciones,
                by = "depto_mun",
                all.x = TRUE)

## MÍNIMA CUANTÍA
minima_cuantia <- SECOP_I %>% 
  filter(tipo_proceso == "Contratación Mínima Cuantía") %>% 
  group_by(depto_mun) %>% 
  summarise(contratos_minima_cuantia = n(),
            valor_contratos_minima_cuantia = sum(valor_total_con_adiciones),
            adiciones_minima_cuantia = sum(valor_adiciones))

# Cambiar nos NA por ceros
municipios <- data.frame( sapply(municipios, cambio_na) )

# agregar la mínima cuantía a la info departamental
municipios <-merge(municipios,
               minima_cuantia,
               by = "depto_mun",
               all.x = TRUE)

# Cambiar nos NA por ceros
municipios <- data.frame( sapply(municipios, cambio_na) )

# pasar a numérico las variables que están como char
municipios[, 2:ncol(municipios)] <- setNames(data.frame(lapply(municipios[, 2:ncol(municipios)], as.numeric)), 
                        colnames(municipios[, 2:ncol(municipios_adiciones)]))

sum(sapply(municipios, is.numeric))

# calcular porcentajes de mínima cuantía
municipios <- municipios %>% 
    mutate(prop_contr_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (contratos_minima_cuantia / contratos)*100)),
           prop_val_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (valor_contratos_minima_cuantia / valor_contratos)*100)),
           prop_dir_adic = as.numeric(sprintf("%.2f", 
                                           (adiciones_directa / adiciones)*100)))

# Cambiar nos NA por ceros
municipios <- data.frame( sapply(municipios, cambio_na) )

# pasar a numérico las variables que están como char
municipios[, 2:ncol(municipios)] <- setNames(data.frame(lapply(municipios[, 2:ncol(municipios)], as.numeric)), 
                        colnames(municipios[, 2:ncol(municipios_adiciones)]))

sum(sapply(deptos, is.numeric))

# crear el vector que determina el orden en que quiero ver las variables
  orden_mun <- c("depto_mun",
                 "contratos",
                 "contratos_directos",
                 "prop_directa",
                 "contratos_adiciones",
                 "contratos_adiciones_dir",
                 "prop_cont_dir_adic",
                 "contratos_minima_cuantia",
                 "prop_contr_minima_cuantia",
                 "valor_contratos",
                 "adiciones",
                 "adiciones_directa",
                 "prop_dir_adic",
                 "valor_contratos_minima_cuantia",
                 "adiciones_minima_cuantia",
                 "prop_val_minima_cuantia")

# ordenar la tabla de acuerdo a como se quiere
municipios <- municipios %>% 
              dplyr::select(all_of(orden_mun))

# LISTO ESTO POR MUNICIPIOS
```

### Entidades hospitales

```{r}
total_contratos <- SECOP_I %>% 
  group_by(nombre_entidad, depto_mun, departamento_entidad) %>% 
  summarise(contratos = n(),
            valor_contratos = sum(valor_total_con_adiciones),
            adiciones = sum(valor_adiciones)) 

total_contratos_directos <- secop_directa %>%
  group_by(nombre_entidad) %>% 
  summarise(contratos_directos = n(),
            adiciones_directa = sum(valor_adiciones))

hospitales <- merge(total_contratos,
                total_contratos_directos,
                by = "nombre_entidad",
                all.y = TRUE) %>% 
  mutate(prop_directa = as.numeric(sprintf("%.2f", 
                                (contratos_directos / contratos)*100)))

## ADICIONES
contratos_adiciones <- SECOP_I %>% 
  filter(valor_adiciones > 0) %>% 
  count(nombre_entidad) %>% 
  rename("contratos_adiciones" = n)

contratos_adiciones_directa <- secop_directa %>% 
  filter(valor_adiciones > 0) %>%
  count(nombre_entidad) %>% 
  rename("contratos_adiciones_dir" = n)

hospitales_adiciones <- merge(contratos_adiciones,
                          contratos_adiciones_directa,
                          by = "nombre_entidad",
                          all.x = TRUE) %>% 
  mutate(prop_cont_dir_adic = as.numeric(sprintf("%.2f",
                                                (contratos_adiciones_dir / contratos_adiciones)*100)))

# Función de cambio de los NA por ceros
cambio_na = function(x){
  ifelse(is.na(x),0,x)
}

# Cambiar nos NA por ceros
hospitales_adiciones <- data.frame( sapply(hospitales_adiciones, cambio_na) )

# convertir a  numércias las columnas 
#deptos[, 2:ncol(deptos)] <- as.numeric(deptos[, 2:ncol(deptos)])
#deptos_adiciones$contratos_adiciones <- as.numeric(deptos_adiciones$contratos_adiciones)
#deptos_adiciones$contratos_adiciones_dir <- as.numeric(deptos_adiciones$contratos_adiciones_dir)
#deptos_adiciones$prop_cont_dir_adic <- as.numeric(deptos_adiciones$prop_cont_dir_adic)

# agregar las adiciones a la tabla de informacion departamental
hospitales <- merge(hospitales,
                hospitales_adiciones,
                by = "nombre_entidad",
                all.x = TRUE)

## MÍNIMA CUANTÍA
minima_cuantia <- SECOP_I %>% 
  filter(tipo_proceso == "Contratación Mínima Cuantía") %>% 
  group_by(nombre_entidad) %>% 
  summarise(contratos_minima_cuantia = n(),
            valor_contratos_minima_cuantia = sum(valor_total_con_adiciones),
            adiciones_minima_cuantia = sum(valor_adiciones))

# Cambiar nos NA por ceros
hospitales <- data.frame( sapply(hospitales, cambio_na) )

# agregar la mínima cuantía a la info departamental
hospitales <-merge(hospitales,
               minima_cuantia,
               by = "nombre_entidad",
               all.x = TRUE)

# Cambiar nos NA por ceros
hospitales <- data.frame( sapply(hospitales, cambio_na) )

# pasar a numérico las variables que están como char
hospitales[, 4:ncol(hospitales)] <- setNames(data.frame(lapply(hospitales[, 4:ncol(hospitales)], as.numeric)), 
                        colnames(hospitales[, 4:ncol(hospitales_adiciones)]))

sum(sapply(hospitales, is.numeric))

# calcular porcentajes de mínima cuantía
hospitales <- hospitales %>% 
    mutate(prop_contr_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (contratos_minima_cuantia / contratos)*100)),
           prop_val_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (valor_contratos_minima_cuantia / valor_contratos)*100)),
           prop_dir_adic = as.numeric(sprintf("%.2f", 
                                           (adiciones_directa / adiciones)*100)))

# Cambiar nos NA por ceros
hospitales <- data.frame( sapply(hospitales, cambio_na) )

# pasar a numérico las variables que están como char
hospitales[, 4:ncol(hospitales)] <- setNames(data.frame(lapply(hospitales[, 4:ncol(hospitales)], as.numeric)), 
                        colnames(hospitales[, 4:ncol(hospitales_adiciones)]))

sum(sapply(deptos, is.numeric))

# crear el vector que determina el orden en que quiero ver las variables
  orden_hos <- c("nombre_entidad",
                 "departamento_entidad",
                 "depto_mun",
                 "contratos",
                 "contratos_directos",
                 "prop_directa",
                 "contratos_adiciones",
                 "contratos_adiciones_dir",
                 "prop_cont_dir_adic",
                 "contratos_minima_cuantia",
                 "prop_contr_minima_cuantia",
                 "valor_contratos",
                 "adiciones",
                 "adiciones_directa",
                 "prop_dir_adic",
                 "valor_contratos_minima_cuantia",
                 "adiciones_minima_cuantia",
                 "prop_val_minima_cuantia")

# ordenar la tabla de acuerdo a como se quiere
hospitales <- hospitales %>% 
              dplyr::select(all_of(orden_hos))

# LISTO ESTO POR HOSPITALES
```


### Unir los indicadores por departamentos y municipios a los hospitales (entidades)

```{r}
#modificar nombres de columnas de cada taba
#depto
orden_depto <- paste("indba", orden_depto, "dto", sep = "_")
names(deptos) <- orden_depto

#municipios
orden_mun <- paste("indba", orden_mun, "mun", sep = "_")
names(municipios) <- orden_mun

#hospitales
orden_hos <- paste("indba", orden_hos, "hos", sep = "_")
names(hospitales) <- orden_hos

# unir los municipios a los hospitales
entidades <- merge(hospitales, municipios, 
                   by.x = "indba_depto_mun_hos",
                   by.y = "indba_depto_mun_mun",
                   all.x = TRUE)

# unir los departamentos a los hospitales
entidades <- merge(entidades, deptos,
                   by.x = "indba_departamento_entidad_hos",
                   by.y = "indba_departamento_ejecucion_dto",
                   all.x = TRUE)

#entidades$departamento_entidad_hos <- NULL

#ver si hay NAs
sapply(entidades, function(x) sum(is.na(x)))

# Escribir el .csv
write.csv(entidades, file = "entidades.csv", row.names = TRUE)
```
