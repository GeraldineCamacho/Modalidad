---
title: "Union indicadores por anios"
author: "Yilber Alejandro Erazo Bolaños"
date: "21/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

librerías

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(readxl)
library(stringr)
```

# 1. AJUTES INICIALES

## 1.1. Indicadores

Lectura de los datos iniciales de los indicadores

```{r}
indicadores <- read_delim("Indicadores_Final.csv", ";")
```

Ajustes a la base de dato de indicadores

```{r}
# Ajustar nombres de algunas entidades territoriales para que coincidad en ambas BDs
indicadores<-as.data.table(indicadores)
indicadores[departamento_entidad=="Bogotá D.C." , departamento_entidad:="Bogotá"]
indicadores[departamento_entidad=="Bogotá" , municipio_entidad:="Bogotá"]
indicadores[departamento_entidad=="Norte De Santander", departamento_entidad:="Norte de Santander"]
# Generar una nueva columna con el nombre del departamento-municipio
indicadores<- unite(indicadores, depto_mun, c("departamento_entidad", "municipio_entidad"), sep = "-", remove = FALSE)
```

Ajuste manual de registros críticos
Reemplazar los datos de indicadores como los nombres de economiatd
cCaso especial: No existe en economíatd Sucre-Sincé , Bolívar-Santa Rosa de Lima

```{r}
indicadores[depto_mun=="Cauca-Paez/Belalcazar" , municipio_entidad:="Paéz"]
indicadores[depto_mun=="Boyacá-Chíquiza (San Pedro de Iguaque)" , municipio_entidad:="Chíquiza"]
indicadores[depto_mun=="Cesar-Manaure Balcon del Cesar" , municipio_entidad:="Manaure"]
indicadores[depto_mun=="Cauca-López de Micay" , municipio_entidad:="López"]
indicadores[depto_mun=="Huila-El Pital" , municipio_entidad:="Pital"]
indicadores[depto_mun=="Antioquia-Carolina del Príncipe" , municipio_entidad:="Carolina"]
indicadores[depto_mun=="Nariño-Cuaspud/Carlosama" , municipio_entidad:="Cuaspud"]
indicadores[depto_mun=="Norte de Santander-San José de Cúcuta" , municipio_entidad:="Cúcuta"]
indicadores[depto_mun=="Tolima-El Espinal" , municipio_entidad:="Espinal"]
indicadores[depto_mun=="Putumayo-San Miguel (La Dorada)" , municipio_entidad:="San Miguel"]
indicadores[depto_mun=="Antioquia-El Peñol" , municipio_entidad:="Peñol"]
indicadores[depto_mun=="Putumayo-San Miguel de Mocoa" , municipio_entidad:="Mocoa"]
indicadores[depto_mun=="Sucre-Toluviejo" , municipio_entidad:="Tolú Viejo"]
indicadores[depto_mun=="Boyacá-Gameza" , municipio_entidad:="Gámeza"]
indicadores[depto_mun=="Bolívar-San Estanislao de Kostka" , municipio_entidad:="San Estanislao"]
indicadores[depto_mun=="Nariño-Roberto Payán/San José" , municipio_entidad:="Roberto Payán"]
indicadores[depto_mun=="Putumayo-Valle del Guamuez/La Hormiga" , municipio_entidad:="Valle del Guamuez"]
indicadores[depto_mun=="Tolima-San Sebastian de Mariquita" , municipio_entidad:="San Sebastián de Mariquita"]
indicadores[depto_mun=="Cundinamarca-Caqueza" , municipio_entidad:="Cáqueza"]
indicadores[depto_mun=="Tolima-El Guamo" , municipio_entidad:="Guamo"]
indicadores[depto_mun=="Tolima-El Líbano" , municipio_entidad:="Líbano"]
indicadores[depto_mun=="Sucre-Coloso" , municipio_entidad:="Colosó"]
indicadores[depto_mun=="Cauca-Toribio" , municipio_entidad:="Toribío"]
indicadores[depto_mun=="Nariño-San Andres de Tumaco" , municipio_entidad:="San Andrés de Tumaco"]
indicadores[depto_mun=="Antioquia-San Pedro de los Milagros" , municipio_entidad:="San Pedro de Los Milagros"]
indicadores[depto_mun=="Antioquia-Anza" , municipio_entidad:="Anzá"]
indicadores[depto_mun=="Nariño-Consaca" , municipio_entidad:="Consacá"]
indicadores[depto_mun=="Quindío-Calarca" , municipio_entidad:="Calarcá"]
indicadores[depto_mun=="Antioquia-Yolombo" , municipio_entidad:="Yolombó"]
indicadores[depto_mun=="Santander-Lebríja" , municipio_entidad:="Lebrija"]
indicadores[depto_mun=="Cundinamarca-Fomeque" , municipio_entidad:="Fómeque"]
indicadores[depto_mun=="Valle del Cauca-Jamundi" , municipio_entidad:="Jamundí"]
indicadores[depto_mun=="Norte de Santander-Abrego" , municipio_entidad:="Ábrego"]
indicadores[depto_mun=="Atlántico-Campo de la Cruz" , municipio_entidad:="Campo de La Cruz"]
indicadores[depto_mun=="Antioquia-San Pedro de Uraba" , municipio_entidad:="San Pedro de Urabá"]
indicadores[depto_mun=="La Guajira-La Jagua Del Pilar" , municipio_entidad:="La Jagua del Pilar"]
indicadores[depto_mun=="Caquetá-Belén de Los Andaquies" , municipio_entidad:="Belén de Los Andaquíes"]
indicadores[depto_mun=="Magdalena-Sabanas de San Angel" , municipio_entidad:="Sabanas de San Ángel"]
indicadores[depto_mun=="Antioquia-San Andrés de Cuerquia" , municipio_entidad:="San Andrés de Cuerquía"]
indicadores[depto_mun=="Antioquia-San José de la Montaña" , municipio_entidad:="San José de La Montaña"]
```

Reemplazr la columna con el nombre del departamento-municipio

```{r}
indicadores$depto_mun<-NULL
indicadores<- unite(indicadores, depto_mun, c("departamento_entidad", "municipio_entidad"), sep = "-", remove = FALSE)
```

# 2. UNIÓN TERRIDATA

Se seleccionaron 4 categorías de indicadores dentro de la plataforma Terridata, esto debido a que según algunos estudios dichas categorías de indicadores puede tener relación con el fenómeno de la corrupción. Las categorías son:
- Economía
- Educación
- Financiero
- Salud

## 2.1. Economía

Se seleccionaron los indicadores de 2 subcategorías de las cuáles se tenían suficientes datos (PIB y ) y el Porcentaje del PIB por grandes ramas de actividad económica) y se cree que pueden tener una relación con el tema de estudio, esto de acuerdo a algunas investigaciones hechas por pares y publicadas en algunos artículos como: [Lista de artículos]

Datos iniciales: base de datos completa, tal cual como está en Terridata.

```{r}
economiatd<- read.csv2("TerriData_Economia", 
                       header = TRUE, 
                       encoding="UTF-8", dec = ".")
```

Ajustes de la base de datos

```{r}
### Ajustar los nombres de la base de datos de economía
economiatd<- economiatd %>%
  rename(cod_departamento = "Código.Departamento", 
         departamento = "Departamento", 
         cod_entidad = "Código.Entidad", 
         entidad = "Entidad", 
         dimension = "Dimensión", 
         subcategoria = "Subcategoría", 
         indicador = "Indicador", 
         dato_numerico = "Dato.Numérico", 
         dato_cualitativo = "Dato.Cualitativo", 
         anno = "Año", 
         mes = "Mes", 
         fuente = "Fuente", 
         unidad_medida = "Unidad.de.Medida")
### Filtros
economiatd<- economiatd[!is.na(economiatd$dato_numerico),]
economiatd<- economiatd %>% filter(anno >=2014)
economiatd<- economiatd %>% filter(departamento != "Colombia")
### Generar una nueva columna con el nombre del departamento-municipio
economiatd<- unite(economiatd, depto_mun,
                   c("departamento","entidad"),
                   sep = "-",
                   remove = FALSE)
```

### 2.1.1. Extraer datos

Por departamentos

```{r}
# Separar datos por departamentos discriminando por años
economia_depto <- economiatd %>% 
  filter( subcategoria == "PIB" | 
            subcategoria == "Porcentaje del PIB por grandes ramas de actividad económica" &
            departamento == entidad, 
          departamento != "Colombia", 
          departamento!= "Bogotá") %>% 
  group_by(cod_departamento, departamento, anno,indicador) %>% 
  dplyr::select(cod_departamento, departamento, anno, indicador, dato_numerico) %>% 
  unite(indicador_annio, c("indicador", "anno"), sep = "_", remove = TRUE)
```

Reemplazar los nombres de los indicadores para eliminar espacios, porcentajes, tildes, comas y hacer los nombres más cortos y entendibles, de tal manera que se pueda pasar el nombre del indicador como coluna.

```{r}
# pasar las mayúsculas a minúsculas
economia_depto$indicador_annio <- tolower(economia_depto$indicador_annio)

# tildes y espacios
economia_depto$indicador_annio <- chartr('ÁÉÍÓÚáéíóú ','AEIOUaeiou_', economia_depto$indicador_annio)

# porcetajes (% y "porcentaje)
economia_depto$indicador_annio <- gsub("%", "perc", economia_depto$indicador_annio)
economia_depto$indicador_annio <- gsub("porcentaje", "perc", economia_depto$indicador_annio)

# eliminar comas
economia_depto$indicador_annio <- gsub(",", "", economia_depto$indicador_annio)
```

Agregar el indicativo del indicador de economía

```{r}
economia_depto$indicador_annio <- str_c("inec", economia_depto$indicador_annio, "dto", sep = "_")
```

Pasar las filas de indicador a columnas

```{r}
economia_depto <- economia_depto %>% 
  pivot_wider(names_from = indicador_annio, values_from = dato_numerico) 
```

Unir los indicadores por departamentos a los indicadores de SECOP

```{r}
indicadores_bd_td<- merge(indicadores,
                       economia_depto,
                       by.x= "departamento_entidad",
                       by.y= "departamento",
                       all.x=TRUE)
```

Por municipios

De los municipios se seleccionaron solo 7 indicadores debido a que solo estos 7 contenían suficientes datos para los municipios

```{r}
# Municipios que están en ambas DBs
economiatdmun <- economiatd %>% filter(economiatd$depto_mun %in% indicadores$depto_mun)

#Separar datos por municipios discriminados por años
economia_municipio <- economiatdmun %>%
  filter(   indicador == "Participación del valor agregado municipal en el departamental" |
              indicador == "Porcentaje del valor agregado por actividades económicas - Actividades primarias" |
              indicador == "Porcentaje del valor agregado por actividades económicas - Actividades secundarias" |
              indicador == "Porcentaje del valor agregado por actividades económicas - Actividades terciarias" |
              indicador == "Valor agregado" |
              indicador == "Valor agregado per cápita" |
              indicador == "Valor agregado per cápita como porcentaje del promedio nacional" ) %>% 
  group_by(depto_mun, cod_entidad, anno, indicador) %>% 
  dplyr::select(depto_mun, cod_entidad, anno, indicador, dato_numerico) %>% 
  unite(indicador_annio, c("indicador", "anno"), sep = "_", remove = TRUE)
```

Reemplazar los nombres de los indicadores para eliminar espacios, porcentajes, tildes, comas y hacer los nombres más cortos y entendibles, de tal manera que se pueda pasar el nombre del indicador como coluna.

```{r}
# pasar las mayúsculas a minúsculas
economia_municipio$indicador_annio <- tolower(economia_municipio$indicador_annio)

#guión
economia_municipio$indicador_annio <- gsub(" - ", " ", economia_municipio$indicador_annio)

# tildes y espacios
economia_municipio$indicador_annio <- chartr('ÁÉÍÓÚáéíóú ','AEIOUaeiou_', economia_municipio$indicador_annio)

# porcetajes (% y "porcentaje)
economia_municipio$indicador_annio <- gsub("%", "perc", economia_municipio$indicador_annio)
economia_municipio$indicador_annio <- gsub("porcentaje", "perc", economia_municipio$indicador_annio)

# eliminar comas
economia_municipio$indicador_annio <- gsub(",", "", economia_municipio$indicador_annio)
```

Agregar el indicativo del indicador de economía

```{r}
economia_municipio$indicador_annio <- str_c("inec", economia_municipio$indicador_annio,"mun", sep = "_")
```

Pasar las filas de indicador a columnas

```{r}
economia_municipio <- economia_municipio %>% 
  pivot_wider(names_from = indicador_annio, values_from = dato_numerico) 
```

Unir las dos bases de datos de economia 

```{r}
### Unir indicadores_BD general con los indicadores municipio (recordar problema con San Andrés y Bogotá)
indicadores_bd_td <- merge(indicadores_bd_td,
                       economia_municipio,
                       by="depto_mun",
                       all.x= FALSE,
                       all.y=TRUE)
```

cambiar nombre de indidacor de corrupción

```{r}
indicadores_bd_td <- indicadores_bd_td %>% 
  rename("indba_riesgo_corrupcion" = "ind_riesgo_corrupcion")
```


### 2.1.2. Procesamiento final economía unida

Ordenar el nombre de las columnas

```{r}
nombres <- c("nombre_entidad", "nit_entidad" , "orden_entidad", 
             "departamento_entidad", "cod_departamento",
             "municipio_entidad", "depto_mun","cod_entidad")
indicadores_BD_O1 <- indicadores_bd_td %>% dplyr::select(!all_of(nombres))
nombres_BD <- c(nombres, names(indicadores_BD_O1))
indicadores_bd_td <- indicadores_bd_td %>% dplyr::select(all_of(nombres_BD))
rm(indicadores_BD_O1)
rm(nombres_BD)
```

Cambiar los NAs por la media de su columna

```{r}
indicadores_bd_td <-as.data.frame(indicadores_bd_td)
# cuáles columnas son numéricas
columnas_numericas <- which(sapply(indicadores_bd_td, is.numeric))
cols_mean <- rep(NA, ncol(indicadores_bd_td))
cols_mean[columnas_numericas] <- colMeans(indicadores_bd_td[, columnas_numericas], na.rm = TRUE)

# reemplaar los NA
for (x in columnas_numericas) {
  indicadores_bd_td[is.na(indicadores_bd_td[,x]), x] <- cols_mean[x]
}
```

Contar cuántos valores faltantes hay

```{r}
sapply(indicadores_bd_td, function(x) sum(is.na(x)))
```

## 2.2. Financiero

### 2.2.1. Ajustes iniciales

Datos filtrados, es decir, este data set contiene solo las variables que se van a utilizar

```{r}
financiero_municipio <- read.csv("TD_ind_finpub_YG.csv", 
                       header = TRUE, 
                       encoding="UTF-8")
```

Renombras las columnas

```{r}
financiero_municipio <- financiero_municipio %>% rename(
  "inf_financiamiento" = "Financiamiento",
  "inf_ind_desemp_fiscal" = "Indicador.de.desempeño.fiscal",
  "inf_ingresos_totales" = "Ingresos.totales",
  "inf_cantidad_proyectos" = "Número.total.de.proyectos",
  "inf_ppa_educacion" = "ppa...Educación",
  "inf_ppa_salud" = "ppa...Salud",
  "inf_regalias_percapita_valor_efec_girado" = "Regalías.per.cápita..Valor.efectivamente.girado.al.municipio.",
  "inf_valor_proyectos" = "Valor.del.número.total.de.proyectos",
  "inf_igpr" = "Índice.de.gestión.de.proyectos.de.regalías..IGPR."
)

# "Índice.de.gestión.de.proyectos.de.regalías..IGPR."
```

Ver cuántos NAs hay por cada columna: Se crea una función que nos de tanto la cantidad de valores faltantes como la proporción de valores faltantes dentro de cada columna, esto se hace con la ayuda de la función de R apply().

```{r}
# Porcentaje de NAs con sapply
sapply(financiero_municipio, function(x) mean(is.na(x)))

# Porcentaje de NAs con apply
apply(is.na(financiero_municipio), 2, mean)

# Función para la Cantidad y porcentaje de NAs por culumna con apply
cantyprop_nas <- function(x){
  cant <- sum(x)
  prop <- mean(x)*100
  return(c(cant, prop))
}

# Aplicar por columna
apply(is.na(financiero_municipio), 2, cantyprop_nas)
```

Crear las columnas como las necesito: que contenga el nombre del indicador, el año el indicador y si es de municipio o de departamento.

Primero pasamos los datos en formato alargado para poder aplicar los cambios que quiero, luego se crea una columna que contenga tanto el nombre del indicador como el año al que pertenece el indicador.

```{r}
financiero_municipio <- financiero_municipio %>% 
  pivot_longer(cols = !c(codigo_entidad, anno), names_to = "indicador", values_to = "valor") %>%
  unite(indicador_year, "indicador", "anno", sep = "_") %>% 
  na.omit()
```

Agregar el indicativo de que el indicador es para el municipio (_mun)

```{r}
financiero_municipio$indicador_year <- str_c(financiero_municipio$indicador_year,
                                             "mun",
                                             sep = "_")

head(financiero_municipio)
```

Pasar los indicadores a columnas de nuevo

```{r}
financiero_municipio <- financiero_municipio %>% 
  pivot_wider(names_from = indicador_year, values_from = valor)
```

Ver de nuevo la cantidad de valores faltantes por cada columna de nuevo, pero esta vez ya se tiene cada indicador por año como columna.

```{r}
# Aplicar por columna
apply(is.na(financiero_municipio), 2, cantyprop_nas)
```

Eliminar las columnas con una alta proporción de faltantes

```{r}
financiero_municipio$inf_cantidad_proyectos_2014_mun <- NULL
#financiero_municipio$inf_cantidad_proyectos_2015_mun <- NULL
financiero_municipio$inf_valor_proyectos_2017_mun <- NULL
financiero_municipio$inf_valor_proyectos_2014_mun <- NULL
financiero_municipio$inf_valor_proyectos_2016_mun <- NULL
```

### 2.2.2. Hacer el merge con los indicaodres_bd_td

```{r}
#financiero_municipio$codigo_entidad <- as.character(financiero_municipio$codigo_entidad)
#indicadores_bd_td <- indicadores_bd_td[, 1:113]
indicadores_bd_td <- merge(indicadores_bd_td,
                           financiero_municipio,
                           by.x = "cod_entidad",
                           by.y = "codigo_entidad", 
                           all.x = TRUE)
```

ver los NAs

```{r}
apply(is.na(indicadores_bd_td), 2, cantyprop_nas)
```


### 2.2.3. Reemplazar los nas por la media de su columna

```{r}
indicadores_bd_td <-as.data.frame(indicadores_bd_td)
# cuáles columnas son numéricas
columnas_numericas <- which(sapply(indicadores_bd_td, is.numeric))
cols_mean <- rep(NA, ncol(indicadores_bd_td))
cols_mean[columnas_numericas] <- colMeans(indicadores_bd_td[, columnas_numericas], na.rm = TRUE)

# reemplaar los NA
for (x in columnas_numericas) {
  indicadores_bd_td[is.na(indicadores_bd_td[,x]), x] <- cols_mean[x]
}

apply(is.na(indicadores_bd_td), 2, cantyprop_nas)

```


## 2.3. Educación

### 2.3.1. Ajustes iniciales

Leer los datos

```{r}
educacion_municipio <- read.csv("ind_anual_educacion.csv")
```

Renombras las columnas

```{r}
educacion_municipio <- educacion_municipio %>% rename(
  "ine_cobertura_neta" = "ine_coberturaNeta",
  "ine_tasa_desercion" = "ine_tasaDesercion",
  "ine_tasa_repitencia" = "ine_tasaRepitencia",
  "ine_tasa_analfabetismo" = "ine_tasaAnalfabetismo",
  "ine_porcentaje_asistencia" = "ine_porcentajeAsistencia",
  "ine_prueba_matematicas" = "ine_pruebaLecturaMatematicas",
  "ine_prueba_lectura_critica" = "ine_pruebaLecturaCritica"
)
```

Ver cuántos NAs hay por cada columna

```{r}
# Función para la Cantidad y porcentaje de NAs por culumna con apply
cantyprop_nas <- function(x){
  cant <- sum(x)
  prop <- mean(x)*100
  return(c(cant, prop))
}

# Aplicar por columna
apply(is.na(educacion_municipio), 2, cantyprop_nas)
```

ver cuántos datos quedan eliminando los nas

```{r}
educacion_municipio %>% na.omit() %>% count(codigo_entidad) %>% arrange(desc(n))
```

Crear las columnas como las necesito: que contenga el nombre del indicador, el año el indicador y si es de municipio o de departamento.

```{r}
educacion_municipio <- educacion_municipio %>% 
  pivot_longer(cols = !c(codigo_entidad, anno), names_to = "indicador", values_to = "valor") %>%
  unite(indicador_year, "indicador", "anno", sep = "_") %>% 
  na.omit()
```

Agregar el indicativo de que el indicador es para el municipio

```{r}
educacion_municipio$indicador_year <- str_c(educacion_municipio$indicador_year, "mun", sep = "_")

head(educacion_municipio)
```

Pasar los indicadores a columnas de nuevo

```{r}
educacion_municipio <- educacion_municipio %>% 
  pivot_wider(names_from = indicador_year, values_from = valor)
```

Ver de nuevo la cantidad de nas

```{r}
# Aplicar por columna
apply(is.na(educacion_municipio), 2, cantyprop_nas)
```

Eliminar la cantidad de proyectos faltante superior al 40%

```{r}
# Ninguno
```

### 2.3.2. Hacer el merge con los indicaodres_bd_td

```{r}
#educacion_municipio$codigo_entidad <- as.character(educacion_municipio$codigo_entidad)
indicadores_bd_td <- merge(indicadores_bd_td,
                           educacion_municipio,
                           by.x = "cod_entidad",
                           by.y = "codigo_entidad", 
                           all.x = TRUE)
```

ver los NAs

```{r}
apply(is.na(indicadores_bd_td), 2, cantyprop_nas)
```


### 2.3.3. Reemplazar los nas por la media de su columna

```{r}
indicadores_bd_td <-as.data.frame(indicadores_bd_td)
# cuáles columnas son numéricas
columnas_numericas <- which(sapply(indicadores_bd_td, is.numeric))
cols_mean <- rep(NA, ncol(indicadores_bd_td))
cols_mean[columnas_numericas] <- colMeans(indicadores_bd_td[, columnas_numericas], na.rm = TRUE)

# reemplaar los NA
for (x in columnas_numericas) {
  indicadores_bd_td[is.na(indicadores_bd_td[,x]), x] <- cols_mean[x]
}

apply(is.na(indicadores_bd_td), 2, cantyprop_nas)

```

## 2.4. Salud

### 2.4.1. Ajustes iniciales

Leer los datos

```{r}
salud_municipio <- read.csv("salud_global_indicadores_years.csv")
salud_municipio$cod_departamento <- as.character(salud_municipio$cod_departamento)
salud_municipio$cod_entidad <- as.character(salud_municipio$cod_entidad)
salud_municipio <- salud_municipio %>% dplyr::select(-c(cod_departamento, depto_mun, departamento))
head(salud_municipio)
```


Cambiar en el nombre lo que es incec_ por ins_

```{r}
salud_municipio <- salud_municipio %>% 
  pivot_longer(cols = !(cod_entidad), names_to = "indicador", values_to = "valor")

salud_municipio$indicador <- gsub("inec_", "ins_", salud_municipio$indicador)

salud_municipio <- salud_municipio %>% 
  pivot_wider(names_from = indicador, values_from = valor)

head(salud_municipio)
```

Ver la cantidad de nas

```{r}
# Aplicar por columna
apply(is.na(salud_municipio), 2, cantyprop_nas)
```

### 2.4.2. Hacer el merge con los indicaodres_bd_td

```{r}
#educacion_municipio$codigo_entidad <- as.character(educacion_municipio$codigo_entidad)
indicadores_bd_td <- merge(indicadores_bd_td,
                           salud_municipio,
                           by = "cod_entidad",
                           all.x = TRUE)
```

Ver de nuevo la cantidad de nas

```{r}
# Aplicar por columna
apply(is.na(indicadores_bd_td), 2, cantyprop_nas)
```

Eliminación de las variables con NAs mayor al 40%

```{r}
indicadores_bd_td <- indicadores_bd_td %>% 
  dplyr::select(-c("ins_razon_de_mortalidad_materna_a_42_dias_2014_mun",
  "ins_razon_de_mortalidad_materna_a_42_dias_2015_mun",
  "ins_razon_de_mortalidad_materna_a_42_dias_2016_mun",
  "ins_razon_de_mortalidad_materna_a_42_dias_2017_mun",
  "ins_cobertura_de_vacunacion_dpt_2017_mun",
  "ins_cobertuna_de_vacunacion_triple_viral_2017_mun",
  "ins_cobertura_del_regimen_subsidiado_2014_dto",
  "ins_cobertura_del_regimen_subsidiado_2015_dto"))
```

### 2.4.3. Reemplazar los NAs con la medi de la columna

```{r}
indicadores_bd_td <-as.data.frame(indicadores_bd_td)
# cuáles columnas son numéricas
columnas_numericas <- which(sapply(indicadores_bd_td, is.numeric))
cols_mean <- rep(NA, ncol(indicadores_bd_td))
cols_mean[columnas_numericas] <- colMeans(indicadores_bd_td[, columnas_numericas], na.rm = TRUE)

# reemplaar los NA
for (x in columnas_numericas) {
  indicadores_bd_td[is.na(indicadores_bd_td[,x]), x] <- cols_mean[x]
}

#apply(is.na(indicadores_bd_td), 2, cantyprop_nas)
#sum(is.na(indicadores_bd_td))
```

# 3. UNIÓN EXTERNOS

Aquí se unen añaden algunos indicadores que no se encontraron en Terridata ni en SECOP, sino que, en fuentes externas

## 3.1. MDM (Medición del Desempeño Municipal)

```{r}
mdm <- read_excel("Resultados_2018_MDM.xlsx")

### Ajustar nombres
nombres_mdm <- c("cod_entidad", "depto" , "municipio" , "grupo_cap_iniciales_mun",
                 "inmdm_gestion_mov_recursos_mun", "inmdm_gestion_ejec_recursos_mun",
                 "inmdm_gestion_ord_territorial_mun", "inmdm_gobno_abierto_transparencia_mun",
                 "inmdm_puntaje_gestion_mun", "inmdm_puesto_gestion_grupo_capacidades_mun",
                 "inmdm_res_educacion_mun", "inmdm_res_salud_mun", "inmdm_res_servicios_mun",
                 "inmdm_res_seguridad_mun", "inmdm_ind_puntaje_res_2017_mun",
                 "inmdm_ind_ppuntaje_res_2018_mun", "inmdm_ajuste_por_resultados_mun",
                 "inmdm_puesto_resultados_grupo_capacidades_mun", "inmdm_puntaje_mdm_2018_mun",
                 "inmdm_puesto_mdm_grupo_capacidades_mun", "inmdm_clasificacion_mun")
names(mdm) <- nombres_mdm
mdm$cod_entidad <- as.numeric(mdm$cod_entidad)

### Seleccionar datos
mdm <- mdm %>% 
  dplyr::select(cod_entidad, inmdm_gestion_mov_recursos_mun, inmdm_gestion_ejec_recursos_mun,
                inmdm_gestion_ord_territorial_mun, inmdm_gobno_abierto_transparencia_mun,
                inmdm_puntaje_gestion_mun,inmdm_ind_ppuntaje_res_2018_mun, inmdm_puntaje_mdm_2018_mun,
                inmdm_clasificacion_mun)

mdm <- mdm %>% mutate(
  inmdm_clasificacion_mun = case_when(inmdm_clasificacion_mun == "Bajo" ~ 1,
                                      inmdm_clasificacion_mun == "Medio" ~ 2,
                                      TRUE ~ 3)
  )
```

Unir el mdm

```{r}
#indicadores_bd_td <- indicadores_bd_td[ , 1:88]

### Agregar MDM a la base de datos de los indicadores
indicadores_bd_td <- merge(indicadores_bd_td,
                           mdm,
                           by = "cod_entidad",
                           all.x = TRUE,
                           all.y = FALSE)
```

escribir base de datos

```{r}
write.csv(indicadores_bd_td, file = "indicadores_bd_td.csv", row.names = TRUE)
```

## 3.2. Mínima cuantía

Hacer la tabla, los datos

### 3.2.1. Departamentos

```{r}
#departamentos
total_contratos <- SECOP_I %>% 
  group_by(departamento_ejecucion) %>% 
  summarise(contratos = n(),
            valor_contratos = sum(valor_total_con_adiciones),
            adiciones = sum(valor_adiciones)) 

total_contratos_directos <- secop_directa %>%
  group_by(departamento_ejecucion) %>% 
  summarise(contratos_directos = n(),
            adiciones_directa = sum(valor_adiciones))

deptos <- merge(total_contratos,
                total_contratos_directos,
                by = "departamento_ejecucion",
                all.x = TRUE) %>% 
  mutate(prop_directa = as.numeric(sprintf("%.2f", 
                                (contratos_directos / contratos)*100)))

# Función de cambio de los NA por ceros
cambio_na = function(x){
  ifelse(is.na(x),0,x)
}

## ADICIONES
contratos_adiciones <- SECOP_I %>% 
  filter(valor_adiciones > 0) %>% 
  count(departamento_ejecucion) %>% 
  rename("contratos_adiciones" = n)

contratos_adiciones_directa <- secop_directa %>% 
  filter(valor_adiciones > 0) %>%
  count(departamento_ejecucion) %>% 
  rename("contratos_adiciones_dir" = n)

deptos_adiciones <- merge(contratos_adiciones,
                          contratos_adiciones_directa,
                          all.x = TRUE) %>% 
  mutate(prop_cont_dir_adic = as.numeric(sprintf("%.2f",
                                                (contratos_adiciones_dir / contratos_adiciones)*100)))

# Cambiar nos NA por ceros
deptos_adiciones <- data.frame( sapply(deptos_adiciones, cambio_na) )

# convertir a  numércias las columnas 
#deptos[, 2:ncol(deptos)] <- as.numeric(deptos[, 2:ncol(deptos)])
#deptos_adiciones$contratos_adiciones <- as.numeric(deptos_adiciones$contratos_adiciones)
#deptos_adiciones$contratos_adiciones_dir <- as.numeric(deptos_adiciones$contratos_adiciones_dir)
#deptos_adiciones$prop_cont_dir_adic <- as.numeric(deptos_adiciones$prop_cont_dir_adic)

# agregar las adiciones a la tabla de informacion departamental
deptos <- merge(deptos,
                deptos_adiciones,
                by = "departamento_ejecucion",
                all.x = TRUE)

## MÍNIMA CUANTÍA
minima_cuantia <- SECOP_I %>% 
  filter(tipo_proceso == "Contratación Mínima Cuantía") %>% 
  group_by(departamento_ejecucion) %>% 
  summarise(contratos_minima_cuantia = n(),
            valor_contratos_minima_cuantia = sum(valor_total_con_adiciones),
            adiciones_minima_cuantia = sum(valor_adiciones))

# agregar la mínima cuantía a la info departamental
deptos <- merge(deptos,
               minima_cuantia,
               by = "departamento_ejecucion",
               all.x = TRUE)

# Cambiar nos NA por ceros
deptos <- data.frame( sapply(deptos, cambio_na) )

# pasar a numérico las variables que están como char
deptos[, 2:ncol(deptos)] <- setNames(data.frame(lapply(deptos[, 2:ncol(deptos)], as.numeric)), 
                        colnames(deptos[, 2:ncol(deptos_adiciones)]))

# calcular porcentajes de mínima cuantía
deptos <- deptos %>% 
    mutate(prop_contr_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (contratos_minima_cuantia / contratos)*100)),
           prop_val_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (valor_contratos_minima_cuantia / valor_contratos)*100)),
           prop_dir_adic = as.numeric(sprintf("%.2f", 
                                           (adiciones_directa / adiciones)*100)))

# Cambiar nos NA por ceros
deptos <- data.frame( sapply(deptos, cambio_na) )

# pasar a numérico las variables que están como char
deptos[, 2:ncol(deptos)] <- setNames(data.frame(lapply(deptos[, 2:ncol(deptos)], as.numeric)), 
                        colnames(deptos[, 2:ncol(deptos_adiciones)]))

sum(sapply(deptos, is.numeric))

# crear el vector que determina el orden en que quiero ver las variables
orden_depto <- c("departamento_ejecucion",
                 "contratos",
                 "contratos_directos",
                 "prop_directa",
                 "contratos_adiciones",
                 "contratos_adiciones_dir",
                 "prop_cont_dir_adic",
                 "contratos_minima_cuantia",
                 "prop_contr_minima_cuantia",
                 "valor_contratos",
                 "adiciones",
                 "adiciones_directa",
                 "prop_dir_adic",
                 "valor_contratos_minima_cuantia",
                 "adiciones_minima_cuantia",
                 "prop_val_minima_cuantia")

# ordenar la tabla de acuerdo a como se quiere
deptos <- deptos %>% 
              dplyr::select(all_of(orden_depto))

# eliminar registro de San Andrés, providencia y santa catalina, otros paises y Colombia
deptos <- deptos[deptos$departamento_ejecucion != "San Andrés, Providencia y Santa Catalina", ]
deptos <- deptos[deptos$departamento_ejecucion != "Otros Paises", ]
deptos <- deptos[deptos$departamento_ejecucion != "Colombia", ]


# LISTO ESTO POR DEPARTAMENTOS
```

### 3.2.2. Municipios

Datos

```{r}
total_contratos <- SECOP_I %>% 
  group_by(depto_mun) %>% 
  summarise(contratos = n(),
            valor_contratos = sum(valor_total_con_adiciones),
            adiciones = sum(valor_adiciones)) 

total_contratos_directos <- secop_directa %>%
  group_by(depto_mun) %>% 
  summarise(contratos_directos = n(),
            adiciones_directa = sum(valor_adiciones))

municipios <- merge(total_contratos,
                total_contratos_directos,
                by = "depto_mun",
                all.x = TRUE) %>% 
  mutate(prop_directa = as.numeric(sprintf("%.2f", 
                                (contratos_directos / contratos)*100)))

## ADICIONES
contratos_adiciones <- SECOP_I %>% 
  filter(valor_adiciones > 0) %>% 
  count(depto_mun) %>% 
  rename("contratos_adiciones" = n)

contratos_adiciones_directa <- secop_directa %>% 
  filter(valor_adiciones > 0) %>%
  count(depto_mun) %>% 
  rename("contratos_adiciones_dir" = n)

municipios_adiciones <- merge(contratos_adiciones,
                          contratos_adiciones_directa,
                          all.x = TRUE) %>% 
  mutate(prop_cont_dir_adic = as.numeric(sprintf("%.2f",
                                                (contratos_adiciones_dir / contratos_adiciones)*100)))

# Función de cambio de los NA por ceros
cambio_na = function(x){
  ifelse(is.na(x),0,x)
}

# Cambiar nos NA por ceros
municipios_adiciones <- data.frame( sapply(municipios_adiciones, cambio_na) )

# convertir a  numércias las columnas 
#deptos[, 2:ncol(deptos)] <- as.numeric(deptos[, 2:ncol(deptos)])
#deptos_adiciones$contratos_adiciones <- as.numeric(deptos_adiciones$contratos_adiciones)
#deptos_adiciones$contratos_adiciones_dir <- as.numeric(deptos_adiciones$contratos_adiciones_dir)
#deptos_adiciones$prop_cont_dir_adic <- as.numeric(deptos_adiciones$prop_cont_dir_adic)

# agregar las adiciones a la tabla de informacion departamental
municipios <- merge(municipios,
                municipios_adiciones,
                by = "depto_mun",
                all.x = TRUE)

## MÍNIMA CUANTÍA
minima_cuantia <- SECOP_I %>% 
  filter(tipo_proceso == "Contratación Mínima Cuantía") %>% 
  group_by(depto_mun) %>% 
  summarise(contratos_minima_cuantia = n(),
            valor_contratos_minima_cuantia = sum(valor_total_con_adiciones),
            adiciones_minima_cuantia = sum(valor_adiciones))

# agregar la mínima cuantía a la info departamental
municipios <-merge(municipios,
               minima_cuantia,
               by = "depto_mun",
               all.x = TRUE)

# Cambiar nos NA por ceros
municipios <- data.frame( sapply(municipios, cambio_na) )

# pasar a numérico las variables que están como char
municipios[, 2:ncol(municipios)] <- setNames(data.frame(lapply(municipios[, 2:ncol(municipios)], as.numeric)), 
                        colnames(municipios[, 2:ncol(municipios_adiciones)]))

sum(sapply(municipios, is.numeric))

# calcular porcentajes de mínima cuantía
municipios <- municipios %>% 
    mutate(prop_contr_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (contratos_minima_cuantia / contratos)*100)),
           prop_val_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (valor_contratos_minima_cuantia / valor_contratos)*100)),
           prop_dir_adic = as.numeric(sprintf("%.2f", 
                                           (adiciones_directa / adiciones)*100)))

# Cambiar nos NA por ceros
municipios <- data.frame( sapply(municipios, cambio_na) )

# pasar a numérico las variables que están como char
municipios[, 2:ncol(municipios)] <- setNames(data.frame(lapply(municipios[, 2:ncol(municipios)], as.numeric)), 
                        colnames(municipios[, 2:ncol(municipios_adiciones)]))

sum(sapply(deptos, is.numeric))

# crear el vector que determina el orden en que quiero ver las variables
  orden_mun <- c("depto_mun",
                 "contratos",
                 "contratos_directos",
                 "prop_directa",
                 "contratos_adiciones",
                 "contratos_adiciones_dir",
                 "prop_cont_dir_adic",
                 "contratos_minima_cuantia",
                 "prop_contr_minima_cuantia",
                 "valor_contratos",
                 "adiciones",
                 "adiciones_directa",
                 "prop_dir_adic",
                 "valor_contratos_minima_cuantia",
                 "adiciones_minima_cuantia",
                 "prop_val_minima_cuantia")

# ordenar la tabla de acuerdo a como se quiere
municipios <- municipios %>% 
              dplyr::select(all_of(orden_mun))

# LISTO ESTO POR MUNICIPIOS
sapply(municipios, function(x) sum(is.na(x)))
```

### 3.2.3. Entidades hospitales

```{r}
total_contratos <- SECOP_I %>% 
  group_by(nombre_entidad, depto_mun, departamento_entidad) %>% 
  summarise(contratos = n(),
            valor_contratos = sum(valor_total_con_adiciones),
            adiciones = sum(valor_adiciones)) 

total_contratos_directos <- secop_directa %>%
  group_by(nombre_entidad) %>% 
  summarise(contratos_directos = n(),
            adiciones_directa = sum(valor_adiciones))

hospitales <- merge(total_contratos,
                total_contratos_directos,
                by = "nombre_entidad",
                all.x = TRUE) %>% 
  mutate(prop_directa = as.numeric(sprintf("%.2f", 
                                (contratos_directos / contratos)*100)))

## ADICIONES
contratos_adiciones <- SECOP_I %>% 
  filter(valor_adiciones > 0) %>% 
  count(nombre_entidad) %>% 
  rename("contratos_adiciones" = n)

contratos_adiciones_directa <- secop_directa %>% 
  filter(valor_adiciones > 0) %>%
  count(nombre_entidad) %>% 
  rename("contratos_adiciones_dir" = n)

hospitales_adiciones <- merge(contratos_adiciones,
                          contratos_adiciones_directa,
                          by = "nombre_entidad",
                          all.x = TRUE) %>% 
  mutate(prop_cont_dir_adic = as.numeric(sprintf("%.2f",
                                                (contratos_adiciones_dir / contratos_adiciones)*100)))

# Función de cambio de los NA por ceros
cambio_na = function(x){
  ifelse(is.na(x),0,x)
}

# Cambiar nos NA por ceros
hospitales_adiciones <- data.frame( sapply(hospitales_adiciones, cambio_na) )

# convertir a  numércias las columnas 
#deptos[, 2:ncol(deptos)] <- as.numeric(deptos[, 2:ncol(deptos)])
#deptos_adiciones$contratos_adiciones <- as.numeric(deptos_adiciones$contratos_adiciones)
#deptos_adiciones$contratos_adiciones_dir <- as.numeric(deptos_adiciones$contratos_adiciones_dir)
#deptos_adiciones$prop_cont_dir_adic <- as.numeric(deptos_adiciones$prop_cont_dir_adic)

# agregar las adiciones a la tabla de informacion departamental
hospitales <- merge(hospitales,
                hospitales_adiciones,
                by = "nombre_entidad",
                all.x = TRUE)

## MÍNIMA CUANTÍA
minima_cuantia <- SECOP_I %>% 
  filter(tipo_proceso == "Contratación Mínima Cuantía") %>% 
  group_by(nombre_entidad) %>% 
  summarise(contratos_minima_cuantia = n(),
            valor_contratos_minima_cuantia = sum(valor_total_con_adiciones),
            adiciones_minima_cuantia = sum(valor_adiciones))

# agregar la mínima cuantía a la info departamental
hospitales <-merge(hospitales,
               minima_cuantia,
               by = "nombre_entidad",
               all.x = TRUE)

# Cambiar nos NA por ceros
hospitales <- data.frame( sapply(hospitales, cambio_na) )

# pasar a numérico las variables que están como char
hospitales[, 4:ncol(hospitales)] <- setNames(data.frame(lapply(hospitales[, 4:ncol(hospitales)], as.numeric)), 
                        colnames(hospitales[, 4:ncol(hospitales_adiciones)]))

sum(sapply(hospitales, is.numeric))

# calcular porcentajes de mínima cuantía
hospitales <- hospitales %>% 
    mutate(prop_contr_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (contratos_minima_cuantia / contratos)*100)),
           prop_val_minima_cuantia = as.numeric(sprintf("%.2f",
                                                (valor_contratos_minima_cuantia / valor_contratos)*100)),
           prop_dir_adic = as.numeric(sprintf("%.2f", 
                                           (adiciones_directa / adiciones)*100)))

# Cambiar nos NA por ceros
hospitales <- data.frame( sapply(hospitales, cambio_na) )

# pasar a numérico las variables que están como char
hospitales[, 4:ncol(hospitales)] <- setNames(data.frame(lapply(hospitales[, 4:ncol(hospitales)], as.numeric)), 
                        colnames(hospitales[, 4:ncol(hospitales_adiciones)]))

sum(sapply(deptos, is.numeric))

# crear el vector que determina el orden en que quiero ver las variables
  orden_hos <- c("nombre_entidad",
                 "departamento_entidad",
                 "depto_mun",
                 "contratos",
                 "contratos_directos",
                 "prop_directa",
                 "contratos_adiciones",
                 "contratos_adiciones_dir",
                 "prop_cont_dir_adic",
                 "contratos_minima_cuantia",
                 "prop_contr_minima_cuantia",
                 "valor_contratos",
                 "adiciones",
                 "adiciones_directa",
                 "prop_dir_adic",
                 "valor_contratos_minima_cuantia",
                 "adiciones_minima_cuantia",
                 "prop_val_minima_cuantia")

# ordenar la tabla de acuerdo a como se quiere
hospitales <- hospitales %>% 
              dplyr::select(all_of(orden_hos))

# LISTO ESTO POR HOSPITALES
```

### 3.2.4. Unir los indicadores por departamentos y municipios a los hospitales (entidades)

```{r}
#modificar nombres de columnas de cada taba
#depto
orden_depto <- paste("indba", orden_depto, "dto", sep = "_")
names(deptos) <- orden_depto

#municipios
orden_mun <- paste("indba", orden_mun, "mun", sep = "_")
names(municipios) <- orden_mun

#hospitales
orden_hos <- paste("indba", orden_hos, "hos", sep = "_")
names(hospitales) <- orden_hos

# unir los municipios a los hospitales
entidades <- merge(hospitales, municipios, 
                   by.x = "indba_depto_mun_hos",
                   by.y = "indba_depto_mun_mun",
                   all.x = TRUE)

# unir los departamentos a los hospitales
entidades <- merge(entidades, deptos,
                   by.x = "indba_departamento_entidad_hos",
                   by.y = "indba_departamento_ejecucion_dto",
                   all.x = TRUE)

#entidades$departamento_entidad_hos <- NULL

#ver si hay NAs
sapply(entidades, function(x) sum(is.na(x)))
```

Crear el csv

```{r}
write.csv(entidades, file = "entidades.csv", row.names = TRUE)
```


## 3.3. Cercanos a fin de año

Extraer los datos

### 3.3.1. Departamentos

```{r}
deptos_finyr <- merge(SECOP_I %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(departamento_entidad) ,
secop_directa %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(departamento_entidad) ,
by = "departamento_entidad",
all.x = TRUE
) %>% rename("indba_contr_finyr_dto" = "n.x",
             "indba_contr_finyr_directa_dto" = "n.y") 

# Cambiar nos NA por ceros
deptos_finyr <- data.frame(sapply(deptos_finyr, cambio_na))

# pasar a numérico las variables que están como char
deptos_finyr[, 2:ncol(deptos_finyr)] <- setNames(data.frame(lapply(deptos_finyr[, 2:ncol(deptos_finyr)], as.numeric)), 
                        colnames(deptos_finyr[, 2:ncol(deptos_finyr)]))

head(deptos_finyr)

deptos_finyr <- deptos_finyr %>% 
  mutate(indba_prop_contr_finyr_dto = as.numeric(sprintf("%.2f", 
                                                     (indba_contr_finyr_directa_dto / indba_contr_finyr_dto)*100)))
```

### 3.3.2. Hospitales

No se calcula por municipios debido a la falta de datos, por lo que casi siempre los datos para los municipios son los mismos que para los hospitales

```{r}
hospitales_finyr <- merge(SECOP_I %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(nombre_entidad, departamento_entidad) ,
secop_directa %>%
  filter(fecha_firma_contrato >= as.Date("2015-12-01") & fecha_firma_contrato <= as.Date("2015-12-31") |
         fecha_firma_contrato >= as.Date("2016-12-01") & fecha_firma_contrato <= as.Date("2016-12-31") |
         fecha_firma_contrato >= as.Date("2017-12-01") & fecha_firma_contrato <= as.Date("2017-12-31") | 
         fecha_firma_contrato >= as.Date("2018-12-01") & fecha_firma_contrato <= as.Date("2018-12-31") | 
         fecha_firma_contrato >= as.Date("2019-12-01") & fecha_firma_contrato <= as.Date("2019-12-31")) %>%
  count(nombre_entidad) ,
by = "nombre_entidad",
all.x = TRUE
) %>% rename("indba_contr_finyr_hos" = "n.x",
             "indba_contr_finyr_directa_hos" = "n.y") 

# Cambiar nos NA por ceros
hospitales_finyr <- data.frame(sapply(hospitales_finyr, cambio_na))

# pasar a numérico las variables que están como char
hospitales_finyr[, 3:ncol(hospitales_finyr)] <- setNames(data.frame(lapply(hospitales_finyr[, 3:ncol(hospitales_finyr)], as.numeric)), 
                        colnames(hospitales_finyr[, 3:ncol(hospitales_finyr)]))

hospitales_finyr <- hospitales_finyr %>% 
  mutate(indba_prop_contr_finyr_hos = as.numeric(sprintf("%.2f", 
                                                     (indba_contr_finyr_directa_hos / indba_contr_finyr_hos)*100)))
```

Merge entre finyr deptos y hospitales para tener todos los datos en una sola bd

```{r}
hospitales_finyr <- merge(hospitales_finyr,
                          deptos_finyr,
                          by = "departamento_entidad",
                          all.x = TRUE) %>% 
  dplyr::select(-departamento_entidad)
```

### 3.3.3. Intentar merge de entidades (hospitales) con indicadores_bd_td y luego con hospitales_finyr

Entre entidades e indicadores_bd_td

```{r}
# entidades con indicadores_bt_td
indicadores_bd_td <- merge( indicadores_bd_td,
                            entidades %>% dplyr::select( indba_nombre_entidad_hos,
                                                         indba_contratos_minima_cuantia_hos,
                                                         indba_prop_contr_minima_cuantia_hos,
                                                         indba_valor_contratos_minima_cuantia_hos,
                                                         indba_prop_val_minima_cuantia_hos,
                                                         indba_contratos_minima_cuantia_dto,
                                                         indba_prop_contr_minima_cuantia_dto,
                                                         indba_valor_contratos_minima_cuantia_dto,
                                                         indba_prop_val_minima_cuantia_dto),
                            by.x = "nombre_entidad",
                            by.y = "indba_nombre_entidad_hos",
                            all.x = TRUE )

sapply(indicadores_bd_td, function(x) sum(is.na(x)))
```

Entre los hospitales_finyr y los indicadores_bd_td

```{r}
indicadores_bd_td <- merge(indicadores_bd_td,
                           hospitales_finyr,
                           by = "nombre_entidad",
                           all.x = TRUE)
```

### 3.3.4. Ajustar los NAs

```{r}
indicadores_bd_td <- data.frame(sapply(indicadores_bd_td, cambio_na))

# pasar a numérico las variables que están como char
indicadores_bd_td[, 9:ncol(indicadores_bd_td)] <- setNames(data.frame(lapply(indicadores_bd_td[, 9:ncol(indicadores_bd_td)], as.numeric)), 
                        colnames(indicadores_bd_td[, 9:ncol(indicadores_bd_td)]))

head(indicadores_bd_td)

sum(sapply(indicadores_bd_td, is.numeric))

sapply(indicadores_bd_td, function(x) sum(is.na(x)))
```

### 3.3.5. Propocion fin de año por hospital

Teniendo la cantidad de contratos a fin de año se puede calcular la proporción que los contratos a fin de año representan en la totalidad del año

```{r}
indicadores_bd_td %>% mutate(
  indba_prop_contr_finyr_total_hos = (indba_contr_finyr_hos / indba_total_contratos )*100 ) %>% dplyr::select(nombre_entidad, indba_prop_contr_finyr_total_hos) %>% arrange(desc(indba_prop_contr_finyr_total_hos))


# en la base de datos
indicadores_bd_td <- indicadores_bd_td %>% mutate(
  indba_prop_contr_finyr_total_hos = (indba_contr_finyr_hos / indba_total_contratos )*100)
```

Escribir el .csv

```{r}
write.csv(indicadores_bd_td, file = "indicadores_bd_td.csv", row.names = TRUE)
```


## 3.4. Supersalud

Leer los datos

```{r}
supersalud <- read_excel("supersalud_indicadores.xlsx")
supersalud <- as.data.table(supersalud)
```

### 3.4.1. Ajsutes supersalud

Corrección de algunos datos

```{r}
supersalud[NIT == "812004010", Entidad := "ESE CAMU DE BUENAVISTA"]
supersalud[NIT == "891200248", Entidad := "ESE HOSPITAL CLARITA SANTOS"]
supersalud[NIT == "800193904", Entidad := "ESE HOSPITAL JUAN PABLO II DE ARATOCA"] # tiene 2 NIT
supersalud[NIT == "890981268", Entidad := "ESE HOSPITAL LA ANUNCIACION DE MUTATA"]
supersalud[NIT == "900066347", Entidad := "ESE HOSPITAL REGIONAL DE SAN GIL"]
supersalud[NIT == "800123106", Entidad := "ESE HOSPITAL VENANCIO DIAZ DIAZ DE SABANETA"]
supersalud[NIT == "834001482", Entidad := "ESE JAIME ALVARADO Y CASTILLA"]
supersalud[NIT == "820002468", Entidad := "ESE PUESTO DE SALUD DE CIENEGA"]
supersalud[NIT == "900147959", Entidad := "ESE CENTRO DE SALUD TIMOTEO RIVEROS CUBILLOS DE UNE"]
supersalud[NIT == "891501104", Entidad := "ESE HOSPITAL DE EL TAMBO"] # tiene 2 NIT
supersalud[NIT == "890981137", Entidad := "ESE HOSPITAL FRANCISCO VALDERRAMA DE TURBO"]
supersalud[NIT == "890982139", Entidad := "ESE HOSPITAL SAN LORENZO DE LIBORINA"]
supersalud[NIT == "804005695", Entidad := "ESE SAN ISIDRO"] #tiene 2 NIT pero 8004MAL
supersalud[NIT == "890802036", Entidad := "HOSPITAL DE SAN MARCOS DE CHINCHINA"]
supersalud[NIT == "809001086", Entidad := "HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS"]
supersalud[NIT == "800130625", Entidad := "HOSPITAL SAN CRISTOBAL DE CIENAGA"]
supersalud[NIT == "890680031", Entidad := "HOSPITAL SAN ANTONIO DE ARBELAEZ"]
supersalud[NIT == "810000913", Entidad := "HOSPITAL SAN FELIX DE LA DORADA"]
supersalud[NIT == "800204497", Entidad := "HOSPITAL SAN JOSE DE GUACHETA"]
supersalud[NIT == "890907254", Entidad := "HOSPITAL SAN JUAN DE DIOS DE RIONEGRO"]
supersalud[NIT == "809001086", Entidad := "HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS"]
supersalud[NIT == "891900356", Entidad := "HOSPITAL SANTANDER DE CAICEDONIA"]
supersalud[NIT == "804015007", Entidad := "IPS CENTRO DE SALUD DE ENCINO"]
```

Ajuste de algunas variables

```{r}
#eliminar tildes
supersalud$Entidad <- chartr('ÁÉÍÓÚ', 'AEIOU', supersalud$Entidad)

#eliminar puntos
supersalud$Entidad  <- gsub("[.]", "", supersalud$Entidad )

#pasar a character
supersalud$NIT <- as.character(supersalud$NIT)
```

### 3.4.2. Ajustes indicadores_db_td

Ajuste de algunas variables

```{r}
# crear columna de modificacion que a la vez es llave
indicadores_bd_td <- indicadores_bd_td %>% 
  separate(nombre_entidad, sep = " - ", into = c("Depto", "Hospital"), remove = FALSE) %>% 
  dplyr::select(-Depto) %>% 
  separate(nit_entidad, sep = "-", into = "nit_entidad")
  
# Cambios para facilidad de comparación de datos
indicadores_bd_td$Hospital <- chartr('ÁÉÍÓÚ', 'AEIOU', indicadores_bd_td$Hospital) #eliminar tildes
indicadores_bd_td$Hospital <- gsub("[.]", "", indicadores_bd_td$Hospital) #eliminar puntos
indicadores_bd_td$nit_entidad <- gsub("[.]", "", indicadores_bd_td$nit_entidad) #eliminar puntos
```

Correción de algunos datos en indicadores_bd_td para lograr el mayor número de coincidencias de la llave codigo de entidad

```{r}
#pasar a data table
indicadores_bd_td <- as.data.table(indicadores_bd_td)

#correción de datos
indicadores_bd_td[Hospital == "ESE CAMU DE BUENAVISTA", nit_entidad := "812004010"]
indicadores_bd_td[Hospital == "ESE CAMU DEL PRADO", nit_entidad := "812002836"]
indicadores_bd_td[Hospital == "ESE CENTRO DE SALUD SAN VICENTE FERRER", nit_entidad := "820003431"]
indicadores_bd_td[Hospital == "ESE CENTRO DE SALUD TIMOTEO RIVEROS CUBILLOS DE UNE", nit_entidad := "900147959"]
indicadores_bd_td[Hospital == "ESE HOSPITAL CLARITA SANTOS", nit_entidad := "891200248"]
indicadores_bd_td[Hospital == "ESE HOSPITAL DE EL TAMBO", nit_entidad := "891501104"]
indicadores_bd_td[Hospital == "ESE HOSPITAL FRANCISCO VALDERRAMA DE TURBO", nit_entidad := "890981137"]
indicadores_bd_td[Hospital == "ESE HOSPITAL JUAN PABLO II DE ARATOCA", nit_entidad := "800193904"]
indicadores_bd_td[Hospital == "ESE HOSPITAL LA ANUNCIACION DE MUTATA", nit_entidad := "890981268"]
indicadores_bd_td[Hospital == "ESE HOSPITAL NUESTRA SEÑORA DE LA CANDELARIA", nit_entidad := "890981719"]
indicadores_bd_td[Hospital == "ESE HOSPITAL NUESTRA SEÑORA SANTA ANA", nit_entidad := "819000626"]
indicadores_bd_td[Hospital == "ESE HOSPITAL REGIONAL DE SAN GIL", nit_entidad := "900066347"]
indicadores_bd_td[Hospital == "ESE HOSPITAL REGIONAL NORTE", nit_entidad := "807008857"]
indicadores_bd_td[Hospital == "ESE HOSPITAL SAN JOSE", nit_entidad := "891901745"]
indicadores_bd_td[Hospital == "ESE HOSPITAL SAN LORENZO DE LIBORINA", nit_entidad := "890982139"]
#indicadores_bd_td[Hospital == "ESE HOSPITAL SAN VICENTE DE PAUL", nit_entidad := ""] # ojo con este
indicadores_bd_td[Hospital == "ESE HOSPITAL VENANCIO DIAZ DIAZ DE SABANETA", nit_entidad := "800123106"]
indicadores_bd_td[Hospital == "ESE JAIME ALVARADO Y CASTILLA", nit_entidad := "834001482"]
indicadores_bd_td[Hospital == "ESE PUESTO DE SALUD DE CIENEGA", nit_entidad := "820002468"]
indicadores_bd_td[Hospital == "ESE SAN ISIDRO", nit_entidad := "804005695"]
indicadores_bd_td[Hospital == "HOSPITAL DE SAN MARCOS DE CHINCHINA", nit_entidad := "890802036"]
indicadores_bd_td[Hospital == "HOSPITAL SAN ANTONIO DE ARBELAEZ", nit_entidad := "890680031"]
indicadores_bd_td[Hospital == "HOSPITAL SAN CRISTOBAL DE CIENAGA", nit_entidad := "800130625"]
indicadores_bd_td[Hospital == "HOSPITAL SAN FELIX DE LA DORADA", nit_entidad := "810000913"]
indicadores_bd_td[Hospital == "HOSPITAL SAN JOSE DE GUACHETA", nit_entidad := "800204497"]
indicadores_bd_td[Hospital == "HOSPITAL SAN JUAN DE DIOS DE RIONEGRO", nit_entidad := "890907254"]
indicadores_bd_td[Hospital == "HOSPITAL SANTANDER DE CAICEDONIA", nit_entidad := "891900356"]
indicadores_bd_td[Hospital == "HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS", nit_entidad := "809001086"]
indicadores_bd_td[Hospital == "IPS CENTRO DE SALUD DE ENCINO", nit_entidad := "804015007"]
```

### 3.4.3. Hacer el merge

```{r}
indicadores_bd_td <- merge(x = indicadores_bd_td,
                              y = supersalud,
                              by.x = "nit_entidad",
                              by.y = "NIT",
                              all.x = TRUE,
                              all.y = FALSE) %>%
  dplyr::select(-Hospital, -Entidad) %>% 
  rename("supers_ind2_efectividad_en_auditoria_hos" = "Indicador2: Efectividad en la auditoría para el mejoramiento continuo de la calidad",
         "supers_ind10_oportunidad_entrega_reporte_info_hos" = "Indicador10: Oportunidad en la entrega del reporte de información en Cumplimiento de la Circular Única o norma que la sustituya.")
```

### 3.4.4. Ajuste de los NAs

```{r}
# Bien porque si no tiene información es como si no cumpliera
# indicador 10
indicadores_bd_td <- indicadores_bd_td %>% mutate(
  supers_ind10_oportunidad_entrega_reporte_info_hos = case_when(
    supers_ind10_oportunidad_entrega_reporte_info_hos == "NO CUMPLE" ~ 0,
    TRUE ~ 1) )

# pasar a factor
indicadores_bd_td$supers_ind10_oportunidad_entrega_reporte_info_hos <- as.factor(indicadores_bd_td$supers_ind10_oportunidad_entrega_reporte_info_hos)


#con el indicador 2
indicadores_bd_td[supers_ind2_efectividad_en_auditoria_hos == "SIN REPORTE", supers_ind2_efectividad_en_auditoria_hos := 0]

indicadores_bd_td[supers_ind2_efectividad_en_auditoria_hos == "NO APLICA", supers_ind2_efectividad_en_auditoria_hos := 1]

indicadores_bd_td$supers_ind2_efectividad_en_auditoria_hos[is.na(indicadores_bd_td$supers_ind2_efectividad_en_auditoria_hos)] <- "0"

indicadores_bd_td$supers_ind2_efectividad_en_auditoria_hos <- as.numeric(indicadores_bd_td$supers_ind2_efectividad_en_auditoria_hos)

head(indicadores_bd_td)
```

Ver si hay datos faltantes

```{r}
apply(is.na(indicadores_bd_td), 2, cantyprop_nas)
```

Escribir el .csv

```{r}
write.csv(indicadores_bd_td, file = "indicadores_bd_td.csv", row.names = TRUE)
```

## 3.5. Reserva

```{r}
indicadores_reserva <- indicadores_bd_td
```

