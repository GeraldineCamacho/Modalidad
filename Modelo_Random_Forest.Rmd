---
title: "Random Forest"
author: "Yilber Alejandro Erazo Bolaños"
date: "11/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
librería
```{r}
#install.packages("ranger")
#install.packages("tidymodels")
library(tidymodels)
library(knitr)
library(readxl)
library(ggplot2)

# Para poder aplicar el step_smote que hace un especia de upsampling
#install.packages("themis")
library(themis)


library(data.table)
library(readr)
```

# Random Forest por regresión

## Preprocesamiento de los datos

Lectura de los datos
```{r}
#supersalud <- read_excel("supersalud_indicadores.xlsx")
indicadores_gen <- read.csv("indicadores_BD.csv")

indicadores_gen %>% filter(nit_entidad == "No registra") %>% arrange(desc(nombre_entidad))
```

Eliminar columnas que no son necesarias
```{r}
indicadores_gen$X <- NULL
indicadores_gen$cod_entidad <- NULL #porque hay muy pccos datos de cada municipio
indicadores_gen$nit_entidad <- NULL
indicadores_gen$cod_departamento <- NULL #porque ya se tiene el ombre del departamento
indicadores_gen$municipio_entidad <- NULL #porque hay muy pocos datos de cada municipio
indicadores_gen$depto_mun <- NULL #porque hay muy pocos datos de cada municipio
indicadores_gen$perc_contr_direct_val <- NULL #porque no tenemos información sobre la contratación directa

#para volver a correr el modelo porque con esta columna genera error 
indicadores_gen$nombre_entidad <- NULL

#pasar a factor las nominales a ver si funciona el modelo
#indicadores_gen$nombre_entidad <- as.factor(indicadores_gen$nombre_entidad)
indicadores_gen$orden_entidad <- as.factor(indicadores_gen$orden_entidad)
indicadores_gen$departamento_entidad <- as.factor(indicadores_gen$departamento_entidad)

# eliminar la columna de los deptos porque no es importante 
#indicadores_gen$departamento_entidad <- NULL
# cuando se elimina los departamentos el r cuadrado baja


# ver si el modelo hace un mejor trabajo solo con los que tienen contr directa >0
#indicadores_gen <- indicadores_gen %>% filter(perc_contr_directa_num>0)
```

División de los datos en train y test
```{r}
set.seed(123)
indicadores_gen_split <- initial_split(indicadores_gen, 
                                       strata = perc_contr_directa_num,
                                       prop = 4/5)
indicadores_gen_train <- training(indicadores_gen_split)
indicadores_gen_test <- testing(indicadores_gen_split)
```

Procesamiento y preparación de variables
```{r}
indicadores_gen_rec <- recipe(perc_contr_directa_num ~ ., data = indicadores_gen) %>% 
  #update_role(nombre_entidad, new_role = "ID") %>% 
  step_normalize(all_numeric(), -perc_contr_directa_num) %>% 
  step_dummy(all_nominal(), one_hot = TRUE)

#indicadores_gen_rec
```

El objeto 'indicadores_gen_rec' es una rutina de preprocesamiento que se puede aplicar a los datos de train y test.
```{r}
indicadores_gen_train_prep <- indicadores_gen_rec %>% 
  prep(indicadores_gen_train) %>% 
  juice()

#head(indicadores_gen_train_prep)
```

## Configurar el modelo

La librería a usar es 'Parsnip'que ofrece una interfaz unificada para la gran variedad de modelos de machine learning que existen en R. Esto significa que solo tiene que utilizar una forma estandar para configurar un modelo, y puede usar esta configuración diferentes tipos de modelos: Módelo Lineal, Ridge, Lasso, Random Forest, Regresión Logística, Arboles, Support Vector Machine, entre otros.
```{r}
indicadores_gen_rf <- rand_forest() %>% 
  set_args(mtry = tune(),
           trees = tune()) %>% 
  set_engine("ranger", importance = "impurity") %>% 
  set_mode("regression")

indicadores_gen_rf %>% translate()
```
## Definir el workflow

El flujo de trabajo permite integrar todas las tareas que se estan desarrollando para entrenar el modelo de machine learning.
```{r}
rf_workflow_reg <- workflow() %>% 
  add_recipe(indicadores_gen_rec) %>% 
  add_model(indicadores_gen_rf)

#rf_workflow_reg
```

## Calibración de parámetros

Para calibrar los parametros se utiliza el metodo de validación cruzada. Este procedimiento tiene como proposito encontrar los parametros optimos del modelo o algoritmo.
```{r}
# creación de los folds
indicadores_gen_cv <- vfold_cv(indicadores_gen_train,
                               v=5)
indicadores_gen_cv
```

Ahora se configuran las metricas que se utilizarán para calibrar los parametros del modelo en la validación cruzada. Primero se define la grilla de valores para los parametros del modelo.
```{r}
rf_gird_reg <- expand.grid(mtry = c(3, 4, 5, 7),
                           trees = c(100, 300, 500))

```

Ahora se corre un modelo de random forest para cada una de estas condiciones.
```{r}
rf_tune_results_reg <- rf_workflow_reg %>% 
  tune_grid(resamples = indicadores_gen_cv,
            grid = rf_gird_reg,
            metrics = metric_set(rmse, mae))

#rf_tune_results_reg
```

A continuación se presenta la tabla que contiene el valor de las metricas para valor de los parametros y de acuerdo a cada metrica.
```{r}
# print results
rf_metrics_reg <- rf_tune_results_reg %>% 
  collect_metrics()

rf_metrics_reg
```
A continuación se presentan un conjunto de gráfica que permiten analizar el comportamiento de las métricas para cada uno de los paramétros del modelo.
```{r}
rf_metrics_reg %>% 
  filter(.metric == "rmse") %>% 
  ggplot(aes(mtry, mean, col = factor(trees))) +
  geom_line(alpha = 0.5, size = 1) +
  ggtitle("RMSE en función del mtry y el número de árboles")
```

grafico2
```{r}
rf_metrics_reg %>% 
  filter(.metric == "mae") %>% 
  ggplot(aes(mtry, mean, col = factor(trees))) +
  geom_line(alpha = 0.5, size = 1) +
  ggtitle("RMSE en función del mtry y el número de árboles")
```

A continuación se presenta el codigo para seleccionar los mejores parametros del modelo en función de la métrica rmse:
```{r}
param_final_reg <- rf_tune_results_reg %>% 
  select_best(metric = "rmse")

param_final_reg
```

## Validación del modelo final

En primer lugar se agregan los parametros calibrado al flujo de trabajo.
```{r}
rf_workflow_reg <- rf_workflow_reg %>% 
  finalize_workflow(param_final_reg)

rf_workflow_reg
```

Ahora se valida con los conjuntos de entrenamiento y prueba. En este caso se toma todo el conjunto de entrenamiento y se construye un modelo con los parametros calibrados del random forest.
```{r}
rf_fit_reg <- rf_workflow_reg %>% 
  last_fit(indicadores_gen_split)

rf_fit_reg
```

Ahora se evalua el rmse con el conjunto de entrenamiento en el modelo final.
```{r}
test_perfomance_reg <- rf_fit_reg %>% collect_metrics()

test_perfomance_reg
```

Comparar los valores reales con las predicciones
```{r}
test_predictions_reg <- rf_fit_reg %>% 
  collect_predictions()

test_predictions_reg
```

Grafico con las predicciones
```{r}
ggplot(test_predictions_reg, aes(perc_contr_directa_num, .pred)) +
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) +
  ggtitle("Valor real (contratación directa) Vs predicción (.pred) TRAIN")

cor.test(test_predictions_reg$perc_contr_directa_num, test_predictions_reg$.pred)
```
## Modelo final
```{r}
final_model <- fit(rf_workflow_reg, indicadores_gen)
final_model
```

## variables de mayor importancia
```{r}
ranger_obj <- pull_workflow_fit(final_model)$fit

rf_importacia_reg <- tibble(variable = names(ranger_obj$variable.importance),
                            importancia = ranger_obj$variable.importance)


importantes <- data.frame(rf_importacia_reg %>% 
                             mutate(variable = forcats::fct_reorder(variable, importancia)) %>% 
                            arrange(desc(importancia)))
#importantes
```

Gráfico de las variables más importantes
```{r}
rf_importacia_reg %>% 
  mutate(variable = forcats::fct_reorder(variable, importancia)) %>% 
   top_n(20) %>% 
  ggplot(aes(variable, importancia)) + 
  geom_bar(stat = "identity") + 
  ggtitle("Importancia de los predictores") +
  coord_flip()

```

NOTA: Cuando se trata de los que SI tuvieron contratación directa el indicador de riesgo de corrupción sigue siendo el segundo más importante pero su valor de importancia se reduce a la mitad.

## Predecir 
```{r}
predicciones <- predict(final_model, new_data = indicadores_gen_test)

#preguntar por esta parte
predicciones <- cbind(predicciones, indicadores_gen_test$perc_contr_directa_num)
names(predicciones) <- c(".pred", "perc_contr_directa_num")
```

## Gráfico del test
```{r}
ggplot(predicciones, aes(perc_contr_directa_num, .pred)) +
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) +
  ggtitle("Valor real (contratación directa) Vs predicción (.pred) TEST")

cor.test(predicciones$perc_contr_directa_num, predicciones$.pred)
```


# Random Forest por clasificación

## Preprocesamiento de los datos

Lectura de los datos
```{r}
indicadores_clas <- read.csv("indicadores_BD.csv")

head(indicadores_clas)
```

Eliminar columnas que no son necesarias
```{r}
indicadores_clas$X <- NULL
indicadores_clas$cod_entidad <- NULL #porque hay muy pccos datos de cada municipio
indicadores_clas$nit_entidad <- NULL
indicadores_clas$cod_departamento <- NULL #porque ya se tiene el ombre del departamento
indicadores_clas$municipio_entidad <- NULL #porque hay muy pocos datos de cada municipio
indicadores_clas$depto_mun <- NULL #porque hay muy pocos datos de cada municipio

#Eliminar contratación directa
indicadores_clas$indba_perc_direc_val <- NULL #porque se supone que no tenemos info de contr. 
indicadores_clas$indba_perc_cerrada_num <- NULL
indicadores_clas$indba_perc_cerrada_val <- NULL

#para volver a correr el modelo porque con esta columna genera error 
indicadores_clas$nombre_entidad <- NULL

# eliminar supersalud que no sé manejar jeje
indicadores_clas$supers_ind2_efectividad_en_auditoria <- NULL

#pasar a factor las nominales a ver si funciona el modelo
#indicadores_gen$nombre_entidad <- as.factor(indicadores_gen$nombre_entidad)
#indicadores_clas$orden_entidad <- as.factor(indicadores_clas$orden_entidad)
#indicadores_clas$departamento_entidad <- as.factor(indicadores_clas$departamento_entidad)

# eliminar la columna de los deptos porque no es importante 
#indicadores_gen$departamento_entidad <- NULL
# cuando se elimina los departamentos el r cuadrado baja


# ver si el modelo hace un mejor trabajo solo con los que tienen contr directa >0
#indicadores_gen <- indicadores_gen %>% filter(perc_contr_directa_num>0)

#crear los rangos
indicadores_clas <- indicadores_clas %>% 
  mutate(riesgo = case_when(indba_perc_cdirec_num <= 25 ~ "Bajo o Moderado",
                            indba_perc_cdirec_num <= 55 ~ "Medio",
                            TRUE ~ "Alto"))

#indicadores_clas$riesgo <- as.factor(indicadores_clas$riesgo)

# Eliminar la columna de la que se sacó la información
#indicadores_clas$perc_contr_directa_num <- NULL

#indicadores_clas$riesgo <- NULL
#Ccalcular los cuartiles
#cartiles <-quantile(indicadores_clas$perc_contr_directa_num)

# crear la columna de los cuartiles
#indicadores_clas <- indicadores_clas %>% 
#  mutate(quartil = case_when(perc_contr_directa_num <= cartiles[2] ~ "Q1",
#                             perc_contr_directa_num <= cartiles[3] ~ "Q2",
#                             perc_contr_directa_num <= cartiles[4] ~ "Q3",
#                             TRUE ~ "Q4") )

#verfiicar que si esta funcionando
#indicadores_clas %>% dplyr::select(perc_contr_directa_num, quartil)

# hacer histograma con la distribucion de los cuartiles
ggplot(indicadores_clas, aes(indba_perc_cdirec_num)) + 
  geom_histogram(col = "white", fill = "gray", aes(y = ..density..)) + 
  geom_density(col = "blue") + 
  geom_vline(xintercept = cartiles[2], color = "red") +
  geom_vline(xintercept = cartiles[3], color = "red") +
  geom_vline(xintercept = cartiles[4], color = "red") + 
  geom_vline(xintercept = cartiles[5], color = "red") +
  scale_x_continuous(breaks = seq(0,100,5)) +
  labs(title = "Distribución de porcentaje de contratación directa",
       x = "Porcentaje de contratación directa",
       y = "Densidad") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5))
```

Eliminar el porcentaje de contratacion directa
```{r}
indicadores_clas$indba_perc_cdirec_num <- NULL

indicadores_clas$supers_ind10_oportunidad_entrega_reporte_info[is.na(indicadores_clas$supers_ind10_oportunidad_entrega_reporte_info)] <- "NO REGISTRA"

indicadores_clas <- indicadores_clas %>% 
  mutate_if(is.character, factor)

head(indicadores_clas[,182:184], 10)
```

División de los datos en train y test
```{r}
set.seed(456)
indicadores_clas_split <- initial_split(indicadores_clas,
                                        strata = riesgo)
indicadores_clas_train <- training(indicadores_clas_split)
indicadores_clas_test <- testing(indicadores_clas_split)
```

Definir las tareas de preprocesamiento

- Normalizar las variables numéricas
-  Crear variables dummyes con las variables categóricas
```{r}
indicadores_clas_rec <- recipe(riesgo ~ .,
                               data = indicadores_clas) %>% 
  step_normalize(all_numeric()) %>% 
  step_other(departamento_entidad) %>% 
  step_dummy(all_nominal(), -riesgo, one_hot = TRUE) %>% 
  step_zv(all_numeric()) 
#%>%
#  step_smote(riesgo)

indicadores_clas_rec %>% prep() %>% bake(new_data =  NULL) %>% count(riesgo)
```

## Definir el modelo random forest

Se configura un modelo con los parametros que trae la función por defecto.
```{r}
rf_model_clas <-  rand_forest() %>% 
  set_engine("ranger",
             importance = "impurity") %>% 
  set_mode("classification") 
```

## Definir el workflow
```{r}
rf_workflow_clas <- workflow() %>% 
  add_recipe(indicadores_clas_rec) %>% 
  add_model(rf_model_clas)
```

## Validar el modelo de random forest
```{r}
rf_val_clas <- rf_workflow_clas %>% 
  last_fit(indicadores_clas_split)

rf_val_clas %>% collect_predictions()
```
## Matriz de confusion
```{r}
rf_val_clas %>% collect_predictions() %>% conf_mat(riesgo, .pred_class)
```

Algunas métricas a partir de la matriz de confusión y otra información de la predicción.

- accuracy: indica en que proporción se predicen bien las dos clases.
- Sensitivity: indica que proporción de las predicciones positivas son correctas, con respecto al total de clases reales positivas. Specificity: indica que proporción de las predicciones negativas son correctas, con respecto al total de clases reales negativas.
- Positive predictive: indica que proporción de las predicciones positivas son correctas, con respecto al total de predicciones.
- Negative predictive: indica que proporción de las prediccion negativas son correctas, con respecto al total de predicciones.

```{r}
# Métricas generales como el auc y accuracy
rf_val_clas %>% collect_metrics()
```

```{r}
# Sensibilidad
rf_val_clas %>% collect_predictions() %>% sensitivity(riesgo, .pred_class)
```

```{r}
# Especificidad
rf_val_clas %>% collect_predictions() %>% specificity(riesgo, .pred_class)
```
positiva
```{r}
# Predicción positiva
rf_val_clas %>% collect_predictions() %>% ppv(riesgo, .pred_class)
```
negativa
```{r}
# Predicción negativa
rf_val_clas %>% collect_predictions() %>% npv(riesgo, .pred_class)
```

A continuación se presenta el número de obervaciones que fueron correctamente clasificadas y el núermo que fue incorrectamente clasificadas
```{r}
#Correcto
rf_val_clas %>% collect_predictions() %>% 
  mutate(correcto = case_when(.pred_class == riesgo ~ "Yes",
                              TRUE ~ "No")) %>% 
  filter(correcto == "Yes") %>%
  count()

# incorrecto
rf_val_clas %>% collect_predictions() %>% 
  mutate(correcto = case_when(.pred_class == riesgo ~ "Yes",
                              TRUE ~ "No")) %>% 
  filter(correcto == "No") %>%
  count()
```

## Modelo final del random forest
```{r}
rf_final_model_clas <- fit(rf_workflow_clas, training(indicadores_clas_split))
rf_final_model_clas
```

## variables de mayor importancia
```{r}
ranger_obj_clas <- pull_workflow_fit(rf_final_model_clas)$fit

rf_importacia_clas <- tibble(variable = names(ranger_obj_clas$variable.importance),
                            importancia = ranger_obj_clas$variable.importance)

rf_importacia_clas

importantes_clas <- data.frame(rf_importacia_clas %>% 
                             mutate(variable = forcats::fct_reorder(variable, importancia)) %>% 
                            arrange(desc(importancia)))
```
## Accuracy

```{r}
# Nivel de accuracy
rf_metric <- rf_val_clas %>% collect_metrics() %>% mutate(model = "Random Forest")
rf_metric
```

Gráfico de las variables más importantes
```{r}
importantes_clas %>% 
  mutate(variable = forcats::fct_reorder(variable, importancia)) %>% 
   top_n(20) %>% 
  ggplot(aes(variable, importancia)) + 
  geom_bar(stat = "identity") + 
  ggtitle("Importancia de los predictores") +
  coord_flip()
```

## Gráfico con los importantes por subcategoría

Hacer un gráfico mostrando la suma total de la importancia de las categorías de los indicadores que se tuvieron en cuenta.
```{r}
# Total
separate(data = importantes_clas,
         col = variable,
         into = "inicio",
         sep = "_") %>% 
  group_by(inicio) %>% 
  summarise(valor = sum(importancia)) %>% 
  ggplot() +
    geom_bar(aes(x = reorder(inicio, valor), y = valor ) ,stat = "identity") +
    coord_flip() +
    labs(x = "Subcategoría de indicador",
         y = "Importancia",
         title = "Importancia total de las subcategorías") +
    theme(plot.title = element_text(hjust = 0.5))

# Promedio
separate(data = importantes_clas,
         col = variable,
         into = "inicio",
         sep = "_") %>% 
  group_by(inicio) %>% 
  summarise(valor = mean(importancia)) %>% 
  ggplot() +
    geom_bar(aes(x = reorder(inicio, valor), y = valor ) ,stat = "identity") +
    coord_flip() +
    labs(x = "Subcategoría de indicador",
         y = "Importancia",
         title = "Importancia media de las subcategorías")+
    theme(plot.title = element_text(hjust = 0.5))
    
```












# Prueba de unión indicador supersalud

```{r}

#leer datos
supersalud <- read_excel("supersalud_indicadores.xlsx")

supersalud <- as.data.table(supersalud)

# Para que coincidan los nombres corregir los nombres de supersalud
supersalud[NIT == "812004010", Entidad := "ESE CAMU DE BUENAVISTA"]
supersalud[NIT == "891200248", Entidad := "ESE HOSPITAL CLARITA SANTOS"]
supersalud[NIT == "800193904", Entidad := "ESE HOSPITAL JUAN PABLO II DE ARATOCA"] # tiene 2 NIT
supersalud[NIT == "890981268", Entidad := "ESE HOSPITAL LA ANUNCIACION DE MUTATA"]
supersalud[NIT == "900066347", Entidad := "ESE HOSPITAL REGIONAL DE SAN GIL"]
supersalud[NIT == "800123106", Entidad := "ESE HOSPITAL VENANCIO DIAZ DIAZ DE SABANETA"]
supersalud[NIT == "834001482", Entidad := "ESE JAIME ALVARADO Y CASTILLA"]
supersalud[NIT == "820002468", Entidad := "ESE PUESTO DE SALUD DE CIENEGA"]
supersalud[NIT == "900147959", Entidad := "ESE CENTRO DE SALUD TIMOTEO RIVEROS CUBILLOS DE UNE"]
supersalud[NIT == "891501104", Entidad := "ESE HOSPITAL DE EL TAMBO"] # tiene 2 NIT
supersalud[NIT == "890981137", Entidad := "ESE HOSPITAL FRANCISCO VALDERRAMA DE TURBO"]
supersalud[NIT == "890982139", Entidad := "ESE HOSPITAL SAN LORENZO DE LIBORINA"]
supersalud[NIT == "804005695", Entidad := "ESE SAN ISIDRO"] #tiene 2 NIT pero 8004MAL
supersalud[NIT == "890802036", Entidad := "HOSPITAL DE SAN MARCOS DE CHINCHINA"]
supersalud[NIT == "809001086", Entidad := "HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS"]
supersalud[NIT == "800130625", Entidad := "HOSPITAL SAN CRISTOBAL DE CIENAGA"]
supersalud[NIT == "890680031", Entidad := "HOSPITAL SAN ANTONIO DE ARBELAEZ"]
supersalud[NIT == "810000913", Entidad := "HOSPITAL SAN FELIX DE LA DORADA"]
supersalud[NIT == "800204497", Entidad := "HOSPITAL SAN JOSE DE GUACHETA"]
supersalud[NIT == "890907254", Entidad := "HOSPITAL SAN JUAN DE DIOS DE RIONEGRO"]
supersalud[NIT == "809001086", Entidad := "HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS"]
supersalud[NIT == "891900356", Entidad := "HOSPITAL SANTANDER DE CAICEDONIA"]
supersalud[NIT == "804015007", Entidad := "IPS CENTRO DE SALUD DE ENCINO"]

#supersalud_unicos <- supersalud %>% unique(Entidad)

data.table(supersalud %>% count(Entidad) %>% arrange(desc(n)))


data.table(supersalud %>% group_by(Entidad)) %>% arrange(Entidad)
#supersalud <- supersalud %>% 
  filter(Entidad %in% supersalud_unicos$Entidad)
  
supersalud %>% count(NIT, Entidad) %>% arrange(desc(n))

supersalud %>% group_by(Entidad) %>% summarise(dis = n_distinct(NIT)) %>% arrange(desc(dis))
```

```{r}

indicadores_prueba <- read.csv("indicadores_BD.csv")

indicadores_prueba <- indicadores_prueba %>% 
  mutate_if(is.character, factor) %>% 
  rename("inmdm_ind_puntaje_res_2018_mun" = "ind_ppuntaje_res_2018_mun",
         "indba_ind_riesgo_corrupcion" = "ind_riesgo_corrupcion")

indicadores_prueba$X <- NULL
indicadores_prueba$cod_entidad <- NULL #porque hay muy pccos datos de cada municipio
#indicadores_prueba$nit_entidad <- NULL
indicadores_prueba$cod_departamento <- NULL #porque ya se tiene el ombre del departamento
indicadores_prueba$municipio_entidad <- NULL #porque hay muy pocos datos de cada municipio
indicadores_prueba$depto_mun <- NULL #porque hay muy pocos datos de cada municipio

#Eliminar contratación directa
indicadores_prueba$indba_perc_direc_val <- NULL #porque se supone que no tenemos info de contr. 
indicadores_prueba$indba_perc_cerrada_num <- NULL
indicadores_prueba$indba_perc_cerrada_val <- NULL

#para volver a correr el modelo porque con esta columna genera error 
#indicadores_clas$nombre_entidad <- NULL


indicadores_prueba <- indicadores_prueba %>% 
  mutate(riesgo = case_when(indba_perc_cdirec_num <= 25 ~ "Bajo o Moderado",
                            indba_perc_cdirec_num <= 55 ~ "Medio",
                            TRUE ~ "Alto"))

indicadores_prueba <- indicadores_prueba[ , c(1:21, 186)]

head(indicadores_prueba)
```

```{r}
supersalud %>% group_by(NIT)
supersalud %>% distinct(Entidad)
indicadores_prueba %>% distinct(nit_entidad)
indicadores_prueba %>% distinct(nombre_entidad)

#ver cuántos coinciden por nombre exacto
supersalud %>% 
  filter(Entidad %in% prueba_union$nombre_entidad)
```


Cambios en supersalud
```{r}
# reemplazar EMPRESA SOCIAL DEL ESTADO por ESE
#supersalud[Entidad]

#eliminar tildes
supersalud$Entidad <- chartr('ÁÉÍÓÚ', 'AEIOU', supersalud$Entidad)

#eliminar puntos
supersalud$Entidad  <- gsub("[.]", "", supersalud$Entidad )

supersalud$NIT <- as.character(supersalud$NIT)

```



```{r}
#hacer el join o merge
indicadores_prueba <- indicadores_prueba %>% 
  separate(nombre_entidad, sep = " - ", into = c("Depto", "Hospital"), remove = FALSE) %>% 
  dplyr::select(-Depto) %>% 
  separate(nit_entidad, sep = "-", into = "nit_entidad")
  
#eliminar tildes
indicadores_prueba$Hospital <- chartr('ÁÉÍÓÚ', 'AEIOU', indicadores_prueba$Hospital)

#eliminar puntos
indicadores_prueba$Hospital <- gsub("[.]", "", indicadores_prueba$Hospital)

indicadores_prueba$nit_entidad <- gsub("[.]", "", indicadores_prueba$nit_entidad)
  
#ver cuántos coinciden 
supersalud %>% filter(Entidad %in% indicadores_prueba$Hospital)

#no_coinciden_super <- supersalud %>% filter(!(NIT %in% prueba_union$nit_entidad) & 
#                                            !(Entidad %in% prueba_union$Hospital))

#no_coinciden_puni <- prueba_union %>% filter(!(nit_entidad %in% supersalud$NIT) &
#                                            !(Hospital %in% supersalud$Entidad))

# Los que sí coinciden por nit o por nombre (862)
indicadores_prueba %>% filter((nit_entidad %in% supersalud$NIT) |
                                            (Hospital %in% supersalud$Entidad))

# Los que sí coinciden por nit (797)
indicadores_prueba %>% filter((nit_entidad %in% supersalud$NIT))

# Los que sí coinciden por nombre pero no por NIT (01)
indicadores_prueba %>% filter((Hospital %in% supersalud$Entidad) &
                                !(nit_entidad %in% supersalud$NIT))

indicadores_prueba_2 <- merge(x = indicadores_prueba,
                              y = supersalud,
                              by.x = "nit_entidad",
                              by.y = "NIT",
                              all.x = TRUE,
                              all.y = FALSE) %>%
  select(-Hospital, -Entidad)
  

no_coinciden_puni %>% filter(Hospital %in% no_coinciden_super$Hospital)

prueba_union %>% filter(nit_entidad %in% supersalud$NIT)

prueba_union %>% 
  filter((nit_entidad %in% supersalud$NIT))

indicadores_prueba %>% filter(nit_entidad > 0)

indicadores_prueba_2 <- indicadores_prueba

indicadores_prueba_2$nit_entidad <- as.numeric(indicadores_prueba_2$nit_entidad)

```

para cambiar el secop (segundos)
```{r}

#supersalud[NIT == "812004010", Entidad := "ESE CAMU DE BUENAVISTA"]

indicadores_prueba <- as.data.table(indicadores_prueba)

indicadores_prueba[Hospital == "ESE CAMU DE BUENAVISTA", nit_entidad := "812004010"]
indicadores_prueba[Hospital == "ESE CAMU DEL PRADO", nit_entidad := "812002836"]
indicadores_prueba[Hospital == "ESE CENTRO DE SALUD SAN VICENTE FERRER", nit_entidad := "820003431"]
indicadores_prueba[Hospital == "ESE CENTRO DE SALUD TIMOTEO RIVEROS CUBILLOS DE UNE", nit_entidad := "900147959"]
indicadores_prueba[Hospital == "ESE HOSPITAL CLARITA SANTOS", nit_entidad := "891200248"]
indicadores_prueba[Hospital == "ESE HOSPITAL DE EL TAMBO", nit_entidad := "891501104"]
indicadores_prueba[Hospital == "ESE HOSPITAL FRANCISCO VALDERRAMA DE TURBO", nit_entidad := "890981137"]
indicadores_prueba[Hospital == "ESE HOSPITAL JUAN PABLO II DE ARATOCA", nit_entidad := "800193904"]
indicadores_prueba[Hospital == "ESE HOSPITAL LA ANUNCIACION DE MUTATA", nit_entidad := "890981268"]
indicadores_prueba[Hospital == "ESE HOSPITAL NUESTRA SEÑORA DE LA CANDELARIA", nit_entidad := "890981719"]
indicadores_prueba[Hospital == "ESE HOSPITAL NUESTRA SEÑORA SANTA ANA", nit_entidad := "819000626"]
indicadores_prueba[Hospital == "ESE HOSPITAL REGIONAL DE SAN GIL", nit_entidad := "900066347"]
indicadores_prueba[Hospital == "ESE HOSPITAL REGIONAL NORTE", nit_entidad := "807008857"]
indicadores_prueba[Hospital == "ESE HOSPITAL SAN JOSE", nit_entidad := "891901745"]
indicadores_prueba[Hospital == "ESE HOSPITAL SAN LORENZO DE LIBORINA", nit_entidad := "890982139"]
#indicadores_prueba[Hospital == "ESE HOSPITAL SAN VICENTE DE PAUL", nit_entidad := ""] # ojo con este
indicadores_prueba[Hospital == "ESE HOSPITAL VENANCIO DIAZ DIAZ DE SABANETA", nit_entidad := "800123106"]
indicadores_prueba[Hospital == "ESE JAIME ALVARADO Y CASTILLA", nit_entidad := "834001482"]
indicadores_prueba[Hospital == "ESE PUESTO DE SALUD DE CIENEGA", nit_entidad := "820002468"]
indicadores_prueba[Hospital == "ESE SAN ISIDRO", nit_entidad := "804005695"]
indicadores_prueba[Hospital == "HOSPITAL DE SAN MARCOS DE CHINCHINA", nit_entidad := "890802036"]
indicadores_prueba[Hospital == "HOSPITAL SAN ANTONIO DE ARBELAEZ", nit_entidad := "890680031"]
indicadores_prueba[Hospital == "HOSPITAL SAN CRISTOBAL DE CIENAGA", nit_entidad := "800130625"]
indicadores_prueba[Hospital == "HOSPITAL SAN FELIX DE LA DORADA", nit_entidad := "810000913"]
indicadores_prueba[Hospital == "HOSPITAL SAN JOSE DE GUACHETA", nit_entidad := "800204497"]
indicadores_prueba[Hospital == "HOSPITAL SAN JUAN DE DIOS DE RIONEGRO", nit_entidad := "890907254"]
indicadores_prueba[Hospital == "HOSPITAL SANTANDER DE CAICEDONIA", nit_entidad := "891900356"]
indicadores_prueba[Hospital == "HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS", nit_entidad := "809001086"]
indicadores_prueba[Hospital == "IPS CENTRO DE SALUD DE ENCINO", nit_entidad := "804015007"]

```




Para cambiar en supersalud (primeros)
```{r}

DT[UID == "17-12-6670053-6063825", valor_inicial:=1568000]

Supersalud --- indicadres
812004010 ESE CAMU BUENAVISTA --- No registra , ESE CAMU DE BUENAVISTA
891200248 ESE HOSPITAL CLARITA SANTOS DE SANDONA --- No registra, ESE HOSPITAL CLARITA SANTOS
800193904 ESE HOSPITAL JUAN PABLO II ARATOCA --- 832193904, ESE HOSPITAL JUAN PABLO II DE ARATOCA
890981268 ESE HOSPITAL LA ANUNCIACION --- No registra, ESE HOSPITAL LA ANUNCIACION DE MUTATA
900066347 ESE HOSPITAL REGIONAL SAN GIL --- No registra, ESE HOSPITAL REGIONAL DE SAN GIL
800123106 ESE HOSPITAL VENANCIO DIAZ DIAZ --- No registra,ESE HOSPITAL VENANCIO DIAZ DIAZ DE SABANETA
834001482 EMPRESA SOCIAL DEL ESTADO JAIME ALVARADO Y CASTILLA --- ESE JAIME ALVARADO Y CASTILLA
820002468 EMPRESA SOCIAL DEL ESTADO PUESTO DE SALUD DE CIENEGA --- No registra, ESE PUESTO DE SALUD DE CIENEGA
900147959 EMPRESA SOCIAL DEL ESTADO CENTRO DE SALUD TIMOTEO RIVEROS CUBILLOS --- No registra, ESE CENTRO DE SALUD TIMOTEO RIVEROS CUBILLOS DE UNE
891501104 EMPRESA SOCIAL DEL ESTADO HOSPITAL DE EL TAMBO CAUCA --- 981501104, ESE HOSPITAL DE EL TAMBO
890981137 EMPRESA SOCIAL DEL ESTADO HOSPITAL FRANCISCO VALDERRAMA --- No registra, ESE HOSPITAL FRANCISCO VALDERRAMA DE TURBO
890982139 EMPRESA SOCIAL DEL ESTADO HOSPITAL SAN LORENZO --- No registra, ESE HOSPITAL SAN LORENZO DE LIBORINA
817003532 QUILISALUD ESE --- 817.003.532, ESE QUILISALUD
804005695 ESE SAN ISIDRO DEL MUNICIPIO DE TONA --- 800400695, ESE SAN ISIDRO 8004MAL
890802036 ESE HOSPITAL SAN MARCOS --- No registra, HOSPITAL DE SAN MARCOS DE CHINCHINA
809001086 HOSPITAL SERAFIN MONTAÑA CUELLAR ESE --- No registra, HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS
800130625 ESE HOSPITAL SAN CRISTOBAL DE CIENAGA --- No registra, HOSPITAL SAN CRISTOBAL DE CIENAGA
890680031 ESE HOSPITAL SAN ANTONIO DE ARBELAEZ --- No registra, HOSPITAL SAN ANTONIO DE ARBELAEZ
810000913 ESE HOSPITAL SAN FELIX - LA DORADA --- No registra, HOSPITAL SAN FELIX DE LA DORADA
800204497 ESE HOSPITAL SAN JOSE DE GUACHETA --- No registra, HOSPITAL SAN JOSE DE GUACHETA
890907254 HOSPITAL SAN JUAN DE DIOS ESE RIONEGRO - ANTIOQUIA --- No registra, HOSPITAL SAN JUAN DE DIOS DE RIONEGRO
809001086 HOSPITAL SERAFIN MONTAÑA CUELLAR ESE --- No registra, HOSPITAL SERAFIN MONTAÑA CUELLAR DE SAN LUIS
891900356 ESE HOSPITAL SANTANDER --- No registra, HOSPITAL SANTANDER DE CAICEDONIA
804015007 ESE CENTRO DE SALUD ENCINO --- No registra, IPS CENTRO DE SALUD DE ENCINO
```



